# Infinite Scroll ‚Äî –ü–æ–¥—Ä–æ–±–Ω–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–¢—Ä–∏–≥–≥–µ—Ä—ã](#—Ç—Ä–∏–≥–≥–µ—Ä—ã)
4. [–ú–µ—Ö–∞–Ω–∏–∑–º –∑–∞–≥—Ä—É–∑–∫–∏](#–º–µ—Ö–∞–Ω–∏–∑–º-–∑–∞–≥—Ä—É–∑–∫–∏)
5. [–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤](#–∑–∞—â–∏—Ç–∞-–æ—Ç-–¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
6. [–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö)
7. [–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–¥–µ—Ç–∞–ª–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## –û–±–∑–æ—Ä

**Infinite Scroll** (–±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞) –≤ –≥—Ä–∞—Ñ–∏–∫–µ —Å–≤–µ—á–µ–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–ª–µ–≤–æ (–≤ –ø—Ä–æ—à–ª–æ–µ). –≠—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É **lazy loading** ‚Äî –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –ª–µ–≤–æ–π –≥—Ä–∞–Ω–∏—Ü–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **`useHistoryLoader`** ‚Äî —è–¥—Ä–æ –ª–æ–≥–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ (FLOW G6)
- **`useChartInteractions`** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FLOW G5)
- **`useViewport`** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç—å—é –≥—Ä–∞—Ñ–∏–∫–∞ (FLOW G3)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ  ‚îÇ   Pan (drag) ‚îÇ         ‚îÇ  Zoom (wheel)‚îÇ                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                         ‚îÇ
          ‚ñº                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         useChartInteractions (FLOW G5)                      ‚îÇ
‚îÇ  ‚Ä¢ handleMouseMove (pan)                                    ‚îÇ
‚îÇ  ‚Ä¢ handleWheel (zoom)                                      ‚îÇ
‚îÇ  ‚Ä¢ –í—ã–∑—ã–≤–∞–µ—Ç: updateViewport(newViewport)                    ‚îÇ
‚îÇ  ‚Ä¢ –í—ã–∑—ã–≤–∞–µ—Ç: onViewportChange(newViewport)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                         ‚îÇ
          ‚îÇ                         ‚îÇ
          ‚ñº                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              useChart (orchestrator)                        ‚îÇ
‚îÇ  ‚Ä¢ onViewportChange: (newViewport) => {                     ‚îÇ
‚îÇ      historyLoader.maybeLoadMore(newViewport);              ‚îÇ
‚îÇ    }                                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         useHistoryLoader (FLOW G6)                          ‚îÇ
‚îÇ  ‚Ä¢ maybeLoadMore(viewport)                                  ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å?                            ‚îÇ
‚îÇ  ‚Ä¢ API –∑–∞–ø—Ä–æ—Å: /api/quotes/candles                          ‚îÇ
‚îÇ  ‚Ä¢ prependCandles() ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –¢—Ä–∏–≥–≥–µ—Ä—ã

Infinite scroll –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ **—Ç—Ä–µ—Ö —Ç–∏–ø–∞—Ö —Å–æ–±—ã—Ç–∏–π**:

### 0. Initial Check ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (FLOW IS-0)

**–§–∞–π–ª:** `frontend/components/chart/useChart.ts`

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ snapshot
- –ü–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ viewport (`recalculateViewport()`)
- –û–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
setTimeout(() => {
  viewport.recalculateViewport();
  viewport.setLatestCandleTime(chartData.getLiveCandle()?.endTime ?? currentTime);
  
  // FLOW IS-0: Initial History Check
  const currentViewport = viewport.getViewport();
  if (currentViewport && chartData.getCandles().length > 0) {
    historyLoader.maybeLoadMore(currentViewport);
  }
}, 0);
```

**–ó–∞—á–µ–º:**
- –ï—Å–ª–∏ viewport —É–∂–µ –±–ª–∏–∑–∫–æ –∫ –ª–µ–≤–æ–π –≥—Ä–∞–Ω–∏—Ü–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç user input
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º `maybeLoadMore`, —á—Ç–æ –∏ –ø—Ä–∏ pan/zoom

**–ó–∞—â–∏—Ç–∞:**
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (–≤ useEffect —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ `[snapshot, timeframe, instrument]`)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (`isLoadingRef`, `loadedRangesRef`)

---

### 1. Pan (Drag) ‚Äî –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞

### 1. Pan (Drag) ‚Äî –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞

**–§–∞–π–ª:** `frontend/components/chart/internal/interactions/useChartInteractions.ts`

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handleMouseMove`

```typescript
const handleMouseMove = (e: MouseEvent) => {
  // ... –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ deltaX ...
  
  // Pan viewport
  const newViewport = panViewportTime({
    viewport,
    deltaX,
    pixelsPerMs,
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º viewport
  updateViewport(newViewport);

  // üî• –í–´–ó–û–í INFINITE SCROLL
  onViewportChange?.(newViewport);
};
```

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∂–∏–º–∞–µ—Ç –ª–µ–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏ –Ω–∞ canvas
- –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç –º—ã—à—å –≤–ª–µ–≤–æ (pan –≤ –ø—Ä–æ—à–ª–æ–µ)
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `onViewportChange`

**–í–∞–∂–Ω–æ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è **–ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏** –≤–æ –≤—Ä–µ–º—è drag, –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ü–µ.

---

### 3. Zoom Out ‚Äî –£–º–µ–Ω—å—à–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞ (–∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏)

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `handleWheel`

```typescript
const handleWheel = (e: WheelEvent) => {
  e.preventDefault();
  
  // ... –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ zoomFactor ...
  
  // Zoom viewport
  const newViewport = zoomViewportTime({
    viewport,
    zoomFactor,
    anchorTime,
    minVisibleCandles: MIN_VISIBLE_CANDLES,
    maxVisibleCandles: MAX_VISIBLE_CANDLES,
    timeframeMs,
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º viewport
  updateViewport(newViewport);

  // üî• –í–´–ó–û–í INFINITE SCROLL
  onViewportChange?.(newViewport);
};
```

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ **–≤–Ω–∏–∑** (zoom out)
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ (–≤–∏–¥–Ω–æ –±–æ–ª—å—à–µ —Å–≤–µ—á–µ–π)
- Viewport —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è –≤–ª–µ–≤–æ, –æ—Ç–∫—Ä—ã–≤–∞—è –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

**–í–∞–∂–Ω–æ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è **–ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–±—ã—Ç–∏–∏ wheel**, –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –≥—Ä–∞–Ω–∏—Ü—ã.

---

## –ú–µ—Ö–∞–Ω–∏–∑–º –∑–∞–≥—Ä—É–∑–∫–∏

### –§—É–Ω–∫—Ü–∏—è `maybeLoadMore`

**–§–∞–π–ª:** `frontend/components/chart/internal/history/useHistoryLoader.ts`

**–°–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```typescript
maybeLoadMore: (viewport: Viewport) => Promise<void>
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `viewport` ‚Äî —Ç–µ–∫—É—â–∞—è –≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞ —Å –ø–æ–ª—è–º–∏:
  - `timeStart` ‚Äî –Ω–∞—á–∞–ª–æ –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (timestamp)
  - `timeEnd` ‚Äî –∫–æ–Ω–µ—Ü –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (timestamp)
  - `priceMin`, `priceMax` ‚Äî –¥–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω

---

### –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–æ—à–∞–≥–æ–≤–æ)

#### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏

```typescript
if (isLoadingRef.current || !hasMoreRef.current) {
  return; // –£–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
}
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–≥—Ä—É–∑–∫–∏ –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç

---

#### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö

```typescript
const candles = getCandles();
if (candles.length === 0) {
  return; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
}
```

**–ó–∞—á–µ–º:** –ù—É–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤–µ—á–∏, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é.

---

#### –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ timestamp —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π —Å–≤–µ—á–∏

```typescript
const toTime = getEarliestRealTime();
if (toTime === null) {
  return; // –ù–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ timestamp (–¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)
}
```

**–í–∞–∂–Ω–æ:** `toTime` ‚Äî —ç—Ç–æ **—Ä–µ–∞–ª—å–Ω—ã–π timestamp –∏–∑ –ë–î**, –Ω–µ normalized. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ API –∑–∞–ø—Ä–æ—Å–µ –∫–∞–∫ `?to=...`.

---

#### –®–∞–≥ 4: –ü–æ–∏—Å–∫ —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π —Å–≤–µ—á–∏ (normalized)

```typescript
const earliestCandle = candles.reduce((earliest, candle) => {
  return candle.startTime < earliest.startTime ? candle : earliest;
}, candles[0]);
const earliestTime = earliestCandle.startTime;
```

**–ó–∞—á–µ–º:** –ù—É–∂–Ω–æ –∑–Ω–∞—Ç—å, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

---

#### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–∏–∑–æ—Å—Ç–∏ viewport –∫ –≥—Ä–∞–Ω–∏—Ü–µ

```typescript
const timeToEarliest = viewport.timeStart - earliestTime;
if (timeToEarliest > PRELOAD_THRESHOLD_MS) {
  return; // –ï—â–µ —Ä–∞–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å
}
```

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞:** `PRELOAD_THRESHOLD_MS = 5000` (5 —Å–µ–∫—É–Ω–¥)

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ `viewport.timeStart` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è **–¥–∞–ª—å—à–µ** —á–µ–º –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –æ—Ç `earliestTime` ‚Üí **–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º**
- –ï—Å–ª–∏ **–±–ª–∏–∂–µ** —á–µ–º –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ ‚Üí **–∑–∞–≥—Ä—É–∂–∞–µ–º**

**–ü—Ä–∏–º–µ—Ä:**
```
earliestTime = 1000000 (—Å–∞–º–∞—è —Ä–∞–Ω–Ω—è—è —Å–≤–µ—á–∞)
viewport.timeStart = 1004999 (–Ω–∞—á–∞–ª–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏)

timeToEarliest = 1004999 - 1000000 = 4999 ms < 5000 ms ‚úÖ –ó–ê–ì–†–£–ñ–ê–ï–ú
```

---

#### –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

```typescript
const currentInstrument = assetRef.current;
const rangeKey = `${currentInstrument}-${toTime}-${HISTORY_LIMIT}`;
if (loadedRangesRef.current.has(rangeKey)) {
  return; // –£–∂–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ —ç—Ç–æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω
}
```

**–§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞:** `"AUDCHF-1000000-200"`

**–ó–∞—â–∏—Ç–∞ –æ—Ç:** –ü–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞–Ω–Ω—ã—Ö.

---

#### –®–∞–≥ 7: –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏

```typescript
isLoadingRef.current = true;
loadedRangesRef.current.add(rangeKey);
```

**–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏:**
- `isLoadingRef` ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- `loadedRangesRef` ‚Äî –ø–æ–º–µ—á–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –∫–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π

---

#### –®–∞–≥ 8: API –∑–∞–ø—Ä–æ—Å

```typescript
const url = `/api/quotes/candles?instrument=${encodeURIComponent(currentInstrument)}&timeframe=${encodeURIComponent(timeframe)}&to=${toTime}&limit=${HISTORY_LIMIT}`;

const response = await api<{ items: SnapshotCandle[] } | SnapshotCandle[]>(url);
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
- `instrument` ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (AUDCHF, EURUSD, ...)
- `timeframe` ‚Äî —Ç–∞–π–º—Ñ—Ä–µ–π–º (5s, 30s, 1m, ...)
- `to` ‚Äî **—Ä–µ–∞–ª—å–Ω—ã–π timestamp** —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π —Å–≤–µ—á–∏ (–ë–î)
- `limit` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π (200)

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º: `SnapshotCandle[]`
- –ò–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º: `{ items: SnapshotCandle[] }`

---

#### –®–∞–≥ 9: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞

```typescript
// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
let items: SnapshotCandle[];
if (Array.isArray(response)) {
  items = response;
} else if (response && 'items' in response && Array.isArray(response.items)) {
  items = response.items;
} else {
  items = [];
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
if (!items || items.length === 0) {
  hasMoreRef.current = false; // –ë–æ–ª—å—à–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  isLoadingRef.current = false;
  return;
}
```

---

#### –®–∞–≥ 10: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ

```typescript
// –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
const sortedCandles = [...items].sort(
  (a, b) => a.startTime - b.startTime
);

// Prepend –≤ data layer
prependCandles(sortedCandles, timeframeMs);
```

**–í–∞–∂–Ω–æ:**
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
- `prependCandles` –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–µ—á–∏ **–≤ –Ω–∞—á–∞–ª–æ** –º–∞—Å—Å–∏–≤–∞ (–±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)

---

#### –®–∞–≥ 11: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –µ—â–µ –¥–∞–Ω–Ω—ã—Ö

```typescript
if (items.length < HISTORY_LIMIT) {
  hasMoreRef.current = false; // –ü—Ä–∏—à–ª–æ –º–µ–Ω—å—à–µ limit ‚Üí –±–æ–ª—å—à–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
}
```

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ **–º–µ–Ω—å—à–µ** —á–µ–º `HISTORY_LIMIT` (200) ‚Üí –±–æ–ª—å—à–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
- –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ **—Ä–æ–≤–Ω–æ** 200 ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –µ—â–µ –¥–∞–Ω–Ω—ã–µ

---

#### –®–∞–≥ 12: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ

```typescript
isLoadingRef.current = false;
```

**–°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É** –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏.

---

## –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### –ú–µ—Ö–∞–Ω–∏–∑–º `loadedRangesRef`

**–¢–∏–ø:** `Set<string>`

**–§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞:**
```typescript
`${instrument}-${toTime}-${limit}`
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```
"AUDCHF-1704067200000-200"
"EURUSD-1704067300000-200"
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```typescript
const rangeKey = `${currentInstrument}-${toTime}-${HISTORY_LIMIT}`;
if (loadedRangesRef.current.has(rangeKey)) {
  return; // –£–∂–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏
}
```

**–°–±—Ä–æ—Å:**
```typescript
const reset = (): void => {
  loadedRangesRef.current = new Set();
  hasMoreRef.current = true;
  isLoadingRef.current = false;
};
```

**–ö–æ–≥–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è:**
- –ü—Ä–∏ —Å–º–µ–Ω–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ (`timeframe`)
- –ü—Ä–∏ —Å–º–µ–Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (`instrument`)
- –ü—Ä–∏ —è–≤–Ω–æ–º –≤—ã–∑–æ–≤–µ `reset()`

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–∞–≥—Ä—É–∑–∫–∏ (User Interaction)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç Pan –≤–ª–µ–≤–æ
   ‚îÇ
   ‚ñº
2. handleMouseMove –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏
   ‚îÇ
   ‚ñº
3. panViewportTime() –≤—ã—á–∏—Å–ª—è–µ—Ç –Ω–æ–≤—ã–π viewport
   ‚îÇ
   ‚ñº
4. updateViewport(newViewport) –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   ‚îÇ
   ‚ñº
5. onViewportChange(newViewport) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   ‚îÇ
   ‚ñº
6. historyLoader.maybeLoadMore(newViewport)
   ‚îÇ
   ‚ñº
7. –ü—Ä–æ–≤–µ—Ä–∫–∞: viewport.timeStart –±–ª–∏–∑–∫–æ –∫ earliestTime?
   ‚îÇ
   ‚îú‚îÄ –ù–ï–¢ ‚Üí return (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º)
   ‚îÇ
   ‚îî‚îÄ –î–ê ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
      ‚îÇ
      ‚ñº
8. –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ —ç—Ç–æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω?
   ‚îÇ
   ‚îú‚îÄ –î–ê ‚Üí return (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º)
   ‚îÇ
   ‚îî‚îÄ –ù–ï–¢ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
      ‚îÇ
      ‚ñº
9. isLoadingRef.current = true
   loadedRangesRef.add(rangeKey)
   ‚îÇ
   ‚ñº
10. API –∑–∞–ø—Ä–æ—Å: GET /api/quotes/candles?to=...
    ‚îÇ
    ‚ñº
11. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
    ‚îÇ
    ‚îú‚îÄ –ü—É—Å—Ç–æ–π ‚Üí hasMoreRef = false, return
    ‚îÇ
    ‚îî‚îÄ –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
       ‚îÇ
       ‚ñº
12. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ startTime
    ‚îÇ
    ‚ñº
13. prependCandles(sortedCandles)
    ‚îÇ
    ‚ñº
14. –ü—Ä–æ–≤–µ—Ä–∫–∞: items.length < HISTORY_LIMIT?
    ‚îÇ
    ‚îú‚îÄ –î–ê ‚Üí hasMoreRef = false
    ‚îÇ
    ‚îî‚îÄ –ù–ï–¢ ‚Üí hasMoreRef –æ—Å—Ç–∞–µ—Ç—Å—è true
       ‚îÇ
       ‚ñº
15. isLoadingRef.current = false
    ‚îÇ
    ‚ñº
16. –ì—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```

---

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–∞–≥—Ä—É–∑–∫–∏ (Initial Check)

```
1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
   ‚îÇ
   ‚ñº
2. Snapshot –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
   ‚îÇ
   ‚ñº
3. chartData.initializeFromSnapshot() ‚Äî –¥–∞–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
   ‚îÇ
   ‚ñº
4. viewport.recalculateViewport() ‚Äî viewport —Ä–∞—Å—Å—á–∏—Ç–∞–Ω
   ‚îÇ
   ‚ñº
5. FLOW IS-0: Initial History Check
   ‚îÇ
   ‚îú‚îÄ viewport == null? ‚Üí return (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º)
   ‚îú‚îÄ candles.length == 0? ‚Üí return (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º)
   ‚îÇ
   ‚îî‚îÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
      ‚îÇ
      ‚ñº
6. historyLoader.maybeLoadMore(currentViewport)
   ‚îÇ
   ‚ñº
7. –ü—Ä–æ–≤–µ—Ä–∫–∞: viewport.timeStart –±–ª–∏–∑–∫–æ –∫ earliestTime?
   ‚îÇ
   ‚îú‚îÄ –ù–ï–¢ ‚Üí return (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º)
   ‚îÇ
   ‚îî‚îÄ –î–ê ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
      ‚îÇ
      ‚ñº
8. –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ —ç—Ç–æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω?
   ‚îÇ
   ‚îú‚îÄ –î–ê ‚Üí return (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º)
   ‚îÇ
   ‚îî‚îÄ –ù–ï–¢ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
      ‚îÇ
      ‚ñº
9. API –∑–∞–ø—Ä–æ—Å ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
   ‚îÇ
   ‚ñº
10. –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å –¥–æ–≥—Ä—É–∂–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
```

---

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã

```typescript
const PRELOAD_THRESHOLD_MS = 5000;  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã
const HISTORY_LIMIT = 200;           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π –∑–∞ –∑–∞–ø—Ä–æ—Å
const MAX_CANDLES = 3000;           // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π –≤ –ø–∞–º—è—Ç–∏
```

**PRELOAD_THRESHOLD_MS:**
- –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ **–∑–∞—Ä–∞–Ω–µ–µ**, –¥–æ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã
- –ü—Ä–∏–º–µ—Ä–Ω–æ 1 —Å–≤–µ—á–∞ –¥–ª—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ 5s
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–ø—É—Å—Ç—ã–µ" –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ

**HISTORY_LIMIT:**
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞
- 200 —Å–≤–µ—á–µ–π = ~16 –º–∏–Ω—É—Ç –¥–ª—è 5s —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞

**MAX_CANDLES:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

### –°–æ—Å—Ç–æ—è–Ω–∏—è (refs)

```typescript
const isLoadingRef = useRef<boolean>(false);      // –ò–¥–µ—Ç –ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞
const hasMoreRef = useRef<boolean>(true);          // –ï—Å—Ç—å –ª–∏ –µ—â–µ –¥–∞–Ω–Ω—ã–µ
const loadedRangesRef = useRef<Set<string>>(new Set()); // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
```

**–ü–æ—á–µ–º—É refs, –∞ –Ω–µ state?**
- –ù–µ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Ä–µ-—Ä–µ–Ω–¥–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
- –ò–∑–±–µ–≥–∞–µ–º –ª–∏—à–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π UI
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∏–∑ –∫–æ–ª–±—ç–∫–æ–≤

---

### API –∑–∞–ø—Ä–æ—Å

**Endpoint:** `GET /api/quotes/candles`

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `instrument` ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (AUDCHF, EURUSD, ...)
- `timeframe` ‚Äî —Ç–∞–π–º—Ñ—Ä–µ–π–º (5s, 30s, 1m, ...)
- `to` ‚Äî **—Ä–µ–∞–ª—å–Ω—ã–π timestamp** (–ë–î) —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π —Å–≤–µ—á–∏
- `limit` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π (200)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```
GET /api/quotes/candles?instrument=AUDCHF&timeframe=5s&to=1704067200000&limit=200
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "items": [
    {
      "open": 0.56960,
      "high": 0.56975,
      "low": 0.56960,
      "close": 0.56963,
      "startTime": 1704067200000,
      "endTime": 1704067205000
    },
    ...
  ]
}
```

---

### –§—É–Ω–∫—Ü–∏—è `prependCandles`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—á–µ–π –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `newCandles: SnapshotCandle[]` ‚Äî –Ω–æ–≤—ã–µ —Å–≤–µ—á–∏
- `timeframeMs: number` ‚Äî —Ç–∞–π–º—Ñ—Ä–µ–π–º –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –î–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–µ—á–∏ –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞
2. –í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –ø–æ `startTime`
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

**–í–∞–∂–Ω–æ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `useChartData`, –Ω–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ `useHistoryLoader`.

---

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
try {
  // ... –∑–∞–≥—Ä—É–∑–∫–∞ ...
} catch (error) {
  console.error('Failed to load history:', error);
  isLoadingRef.current = false;
  // –ù–µ –ø–æ–º–µ—á–∞–µ–º hasMore = false, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
}
```

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
- –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
- **–ù–µ** –ø–æ–º–µ—á–∞–µ–º `hasMore = false` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É

---

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ refs –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

```typescript
const assetRef = useRef(asset);
assetRef.current = asset;

// –í maybeLoadMore:
const currentInstrument = assetRef.current; // –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–ó–∞—á–µ–º:** –ö–æ–ª–±—ç–∫–∏ `pan`/`zoom` –º–æ–≥—É—Ç –∏–º–µ—Ç—å stale closure –∏–∑-–∑–∞ `useEffect` —Å –ø—É—Å—Ç—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏.

---

### 2. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è timestamp

**–î–≤–∞ —Ç–∏–ø–∞ timestamp:**
- **Normalized** ‚Äî `startTime`/`endTime` —Å–≤–µ—á–µ–π (–≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã–µ –ø–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º—É)
- **Real** ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ timestamp –∏–∑ –ë–î (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ API)

**–ü—Ä–∏–º–µ—Ä:**
```
Normalized: 1704067200000 (–≤—ã—Ä–æ–≤–Ω–µ–Ω –Ω–∞ –≥—Ä–∞–Ω–∏—Ü—É —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞)
Real:       1704067201234 (—Ä–µ–∞–ª—å–Ω—ã–π timestamp –∏–∑ –ë–î)
```

**–ó–∞—á–µ–º:** API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ timestamp –¥–ª—è —Ç–æ—á–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

### 3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞

```typescript
const sortedCandles = [...items].sort(
  (a, b) => a.startTime - b.startTime
);
```

**–ó–∞—á–µ–º:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–≤–µ—á–µ–π (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º), –¥–∞–∂–µ –µ—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ä—è–¥–∫–µ.

---

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç

```typescript
if (!items || items.length === 0) {
  hasMoreRef.current = false;
  isLoadingRef.current = false;
  return;
}
```

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- –î–æ—Å—Ç–∏–≥–ª–∏ –Ω–∞—á–∞–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 0: Initial Check (FLOW IS-0)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫
2. Snapshot –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: —Å–≤–µ—á–∏ —Å 10:00 –¥–æ 10:05 (60 —Å–≤–µ—á–µ–π)
3. Viewport —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è: timeStart = 10:00, timeEnd = 10:05
4. FLOW IS-0: Initial History Check –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
5. maybeLoadMore –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: earliestTime = 10:00, viewport.timeStart = 10:00
6. timeToEarliest = 10:00 - 10:00 = 0 ms
7. –ü—Ä–æ–≤–µ—Ä–∫–∞: timeToEarliest (0) < PRELOAD_THRESHOLD_MS (5000)? ‚Üí –î–ê ‚úÖ
8. –ó–ê–ì–†–£–ñ–ê–ï–ú –∏—Å—Ç–æ—Ä–∏—é –¥–æ 10:00 (–µ—Å–ª–∏ –µ—Å—Ç—å)
9. –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å –¥–æ–≥—Ä—É–∂–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
10. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ò–ß–ï–ì–û –Ω–µ –¥–µ–ª–∞–ª ‚Äî –∏—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å —Å–∞–º–∞
```

**–í–∞–∂–Ω–æ:** –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –±–µ–∑ user input.

---

### –ü—Ä–∏–º–µ—Ä 1: Pan –≤–ª–µ–≤–æ

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–µ—á–∏ —Å 10:00 –¥–æ 10:05
2. –ó–∞–∂–∏–º–∞–µ—Ç –º—ã—à—å –∏ —Ç—è–Ω–µ—Ç –≤–ª–µ–≤–æ
3. Viewport —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è: —Ç–µ–ø–µ—Ä—å –≤–∏–¥–Ω–æ 09:55 - 10:00
4. maybeLoadMore –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: earliestTime = 10:00, viewport.timeStart = 09:55
5. timeToEarliest = 09:55 - 10:00 = -5000 ms (–≤ –ø—Ä–æ—à–ª–æ–µ)
6. –ü—Ä–æ–≤–µ—Ä–∫–∞: |timeToEarliest| < PRELOAD_THRESHOLD_MS? ‚Üí –î–ê
7. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ 09:55
8. –ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ —Å–≤–µ—á–∞–º–∏
```

---

### –ü—Ä–∏–º–µ—Ä 2: Zoom out

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–µ—á–∏ —Å 10:00 –¥–æ 10:05 (60 —Å–≤–µ—á–µ–π)
2. –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∫–æ–ª–µ—Å–∏–∫–æ –≤–Ω–∏–∑ (zoom out)
3. Viewport —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è: —Ç–µ–ø–µ—Ä—å –≤–∏–¥–Ω–æ 09:50 - 10:05 (120 —Å–≤–µ—á–µ–π)
4. maybeLoadMore –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: earliestTime = 10:00, viewport.timeStart = 09:50
5. timeToEarliest = 09:50 - 10:00 = -10000 ms
6. –ü—Ä–æ–≤–µ—Ä–∫–∞: |timeToEarliest| > PRELOAD_THRESHOLD_MS? ‚Üí –î–ê (–µ—â–µ —Ä–∞–Ω–æ)
7. –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º (–µ—Å—Ç—å –∑–∞–ø–∞—Å)
8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç zoom out
9. Viewport: 09:45 - 10:05
10. timeToEarliest = 09:45 - 10:00 = -15000 ms
11. –ü—Ä–æ–≤–µ—Ä–∫–∞: |timeToEarliest| > PRELOAD_THRESHOLD_MS? ‚Üí –î–ê (–µ—â–µ —Ä–∞–Ω–æ)
12. –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
13. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç pan –≤–ª–µ–≤–æ –¥–æ 09:46
14. timeToEarliest = 09:46 - 10:00 = -14000 ms
15. –ü—Ä–æ–≤–µ—Ä–∫–∞: |timeToEarliest| > PRELOAD_THRESHOLD_MS? ‚Üí –î–ê (–µ—â–µ —Ä–∞–Ω–æ)
16. –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
17. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç pan –¥–æ 09:56
18. timeToEarliest = 09:56 - 10:00 = -4000 ms
19. –ü—Ä–æ–≤–µ—Ä–∫–∞: |timeToEarliest| < PRELOAD_THRESHOLD_MS? ‚Üí –î–ê ‚úÖ
20. –ó–ê–ì–†–£–ñ–ê–ï–ú –¥–∞–Ω–Ω—ã–µ –¥–æ 09:56
```

---

### –ü—Ä–∏–º–µ—Ä 3: –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—Ç–∏–ª –¥–æ —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω: to=1704067000000, limit=200
3. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 50 —Å–≤–µ—á–µ–π (–º–µ–Ω—å—à–µ limit)
4. –ü—Ä–æ–≤–µ—Ä–∫–∞: items.length (50) < HISTORY_LIMIT (200)? ‚Üí –î–ê
5. hasMoreRef.current = false
6. –ë–æ–ª—å—à–µ –∑–∞–≥—Ä—É–∑–æ–∫ –Ω–µ –±—É–¥–µ—Ç
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å pan, –Ω–æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
```

---

## –†–µ–∑—é–º–µ

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç infinite scroll:

1. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é** –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –ª–µ–≤–æ–π –≥—Ä–∞–Ω–∏—Ü–µ
2. ‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã** —á–µ—Ä–µ–∑ `loadedRangesRef`
3. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã** —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É –±–ª–∏–∑–æ—Å—Ç–∏ –∫ –≥—Ä–∞–Ω–∏—Ü–µ
4. ‚úÖ **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏** –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫

### –ß—Ç–æ –µ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç:

1. **Initial Check (FLOW IS-0)** ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞
2. **Pan (drag)** ‚Äî –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏ –≤–ª–µ–≤–æ
3. **Zoom out** ‚Äî –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –∫–æ–ª–µ—Å–∏–∫–∞ –≤–Ω–∏–∑

### –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

- **PRELOAD_THRESHOLD_MS = 5000** ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã
- **HISTORY_LIMIT = 200** ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π –∑–∞ –∑–∞–ø—Ä–æ—Å
- **MAX_CANDLES = 3000** ‚Äî –º–∞–∫—Å–∏–º—É–º —Å–≤–µ—á–µ–π –≤ –ø–∞–º—è—Ç–∏

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º:

- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã ‚Äî `isLoadingRef`
- ‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã ‚Äî `loadedRangesRef`
- ‚úÖ Stale closure ‚Äî `assetRef.current`
- ‚úÖ –ü—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ `items.length === 0`
- ‚úÖ –û—à–∏–±–∫–∏ —Å–µ—Ç–∏ ‚Äî catch —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `frontend/components/chart/internal/history/useHistoryLoader.ts` ‚Äî —è–¥—Ä–æ –ª–æ–≥–∏–∫–∏
- `frontend/components/chart/internal/interactions/useChartInteractions.ts` ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä—ã
- `frontend/components/chart/useChart.ts` ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
- `frontend/components/chart/internal/useViewport.ts` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ viewport

---

---

## FLOW IS-0: Initial History Check

### –ü—Ä–æ–±–ª–µ–º–∞

–î–æ FLOW IS-0 infinite scroll —Ç—Ä–∏–≥–≥–µ—Ä–∏–ª—Å—è **—Ç–æ–ª—å–∫–æ** –æ—Ç user interactions (pan/zoom). –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª, `maybeLoadMore()` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏:
- –°–ª–µ–≤–∞ –ø—É—Å—Ç–æ
- Viewport —É–∂–µ "—É–ø—ë—Ä—Å—è" –≤ –∫—Ä–∞–π –¥–∞–Ω–Ω—ã—Ö

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è interaction-based –º–æ–¥–µ–ª–∏, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è initial load.

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω **lifecycle-based trigger** ‚Äî initial check –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø:**
- ‚úÖ User interactions (pan/zoom) ‚Äî —É–∂–µ –±—ã–ª–æ
- ‚úÖ Lifecycle / viewport recalculation ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ú–µ—Å—Ç–æ:** `useChart.ts` (–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)

**–ú–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞:**
- –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ snapshot
- –ü–æ—Å–ª–µ `recalculateViewport()`
- –ü–æ—Å–ª–µ `setLatestCandleTime()`
- –û–¥–∏–Ω —Ä–∞–∑ –≤ `useEffect` —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ `[snapshot, timeframe, instrument]`

**–ö–æ–¥:**
```typescript
setTimeout(() => {
  viewport.recalculateViewport();
  viewport.setLatestCandleTime(chartData.getLiveCandle()?.endTime ?? currentTime);
  
  // FLOW IS-0: Initial History Check
  const currentViewport = viewport.getViewport();
  if (currentViewport && chartData.getCandles().length > 0) {
    historyLoader.maybeLoadMore(currentViewport);
  }
}, 0);
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ù–ï –∫–æ—Å—Ç—ã–ª—å

- ‚ùå –ù–µ —Ç–∞–π–º–µ—Ä (setTimeout –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å recalculateViewport)
- ‚ùå –ù–µ polling
- ‚ùå –ù–µ "–º–∞–≥–∏—è"
- ‚ùå –ù–µ –¥—É–±–ª–∏—Ä—É–µ—Ç interaction flow

–ê —ç—Ç–æ:
- ‚úÖ Lifecycle-based trigger
- ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
- ‚úÖ –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º (`maybeLoadMore`)
- ‚úÖ Zero special cases

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:
- `isLoadingRef` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `hasMoreRef` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
- `loadedRangesRef` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### –ö—Ä–∏—Ç–µ—Ä–∏–π "–≥–æ—Ç–æ–≤–æ"

–ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞:
1. –û—Ç–∫—Ä—ã–≤–∞–µ—à—å –≥—Ä–∞—Ñ–∏–∫
2. **–ù–ò–ß–ï–ì–û –Ω–µ –¥–µ–ª–∞–µ—à—å**
3. –ï—Å–ª–∏ viewport –±–ª–∏–∑–∫–æ –∫ earliest candle ‚Üí –∏—Å—Ç–æ—Ä–∏—è –¥–æ–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–∞–º–∞
4. –î–∞–ª—å—à–µ infinite scroll —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –æ—Ç pan/zoom, –∫–∞–∫ —Å–µ–π—á–∞—Å

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-29
