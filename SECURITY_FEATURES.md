# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è](#—Å–º–µ–Ω–∞-–ø–∞—Ä–æ–ª—è)
2. [–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏](#–∞–∫—Ç–∏–≤–Ω—ã–µ-—Å–µ—Å—Å–∏–∏)
3. [–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)](#–¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è-2fa)

---

## üîê –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /api/user/change-password`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ä–æ–ª—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
- ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è (bcrypt)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** (`user.controller.ts`):
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `currentPassword` –∏ `newPassword` –∏–∑ body
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ middleware)
   - –í—ã–∑—ã–≤–∞–µ—Ç `UserService.changePassword()`

2. **–°–µ—Ä–≤–∏—Å** (`UserService.changePassword()`):
   ```typescript
   async changePassword({
     userId,
     currentPassword,
     newPassword,
   }): Promise<void>
   ```
   - –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `userId`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ `verifyPassword()`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
   - –•–µ—à–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ `hashPassword()`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ `userRepository.updatePassword()`

3. **–•—Ä–∞–Ω–µ–Ω–∏–µ:**
   - –ü–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users` (–ø–æ–ª–µ `password`)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è bcrypt –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - –•–µ—à —Ç–æ–∫–µ–Ω–∞ —Å–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `sessions.tokenHash`

**–§–∞–π–ª—ã:**
- `backend/src/modules/user/user.controller.ts` (—Å—Ç—Ä–æ–∫–∏ 195-230)
- `backend/src/domain/user/UserService.ts` (—Å—Ç—Ä–æ–∫–∏ 142-178)
- `backend/src/modules/user/user.schema.ts` (—Å—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
- `backend/src/modules/user/user.routes.ts` (—Ä–æ—É—Ç)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í –∫–æ–¥–µ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Å—Ç—Ä–æ–∫–∞ 176-177):
```typescript
// üî• –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π
// await this.sessionRepository.deleteAllByUserId(userId);
```
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è **–Ω–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Å—Å–∏–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

---

## üíª –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏

### ‚úÖ –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- ‚úÖ –ú–æ–¥–µ–ª—å `Session` –≤ Prisma (`prisma/schema.prisma`)
- ‚úÖ `SessionRepository` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (`ports/repositories/SessionRepository.ts`)
- ‚úÖ `PrismaSessionRepository` —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (`infrastructure/prisma/PrismaSessionRepository.ts`)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (`AuthService`)
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø–æ —Ç–æ–∫–µ–Ω—É (`deleteByToken`)
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`deleteAllByUserId`)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Session:**
```typescript
interface Session {
  id: string;
  userId: string;
  tokenHash: string;  // –•–µ—à —Ç–æ–∫–µ–Ω–∞ —Å–µ—Å—Å–∏–∏
  expiresAt: Date;    // –î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è (30 –¥–Ω–µ–π)
  createdAt: Date;    // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
}
```

**–ß—Ç–æ —É–º–µ–µ—Ç SessionRepository:**
- `create()` - —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é
- `findByToken()` - –Ω–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –ø–æ —Ö–µ—à—É —Ç–æ–∫–µ–Ω–∞
- `deleteByToken()` - —É–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ —Ç–æ–∫–µ–Ω—É
- `deleteAllByUserId()` - —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### ‚ùå –ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è UI "–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏"

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   ```typescript
   // –í SessionRepository –¥–æ–±–∞–≤–∏—Ç—å:
   findAllByUserId(userId: string): Promise<Session[]>;
   ```

2. **–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ø–æ ID:**
   ```typescript
   // –í SessionRepository –¥–æ–±–∞–≤–∏—Ç—å:
   deleteById(sessionId: string): Promise<void>;
   ```

3. **–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π:**
   ```typescript
   // –í SessionRepository –¥–æ–±–∞–≤–∏—Ç—å:
   deleteAllExcept(userId: string, currentTokenHash: string): Promise<void>;
   ```

4. **–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
   - `GET /api/user/sessions` - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
   - `DELETE /api/user/sessions/:sessionId` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–µ—Å—Å–∏—é
   - `DELETE /api/user/sessions/others` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π

5. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è UI:**
   - User-Agent (–±—Ä–∞—É–∑–µ—Ä, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ) - **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ
   - IP –∞–¥—Ä–µ—Å - **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ
   - –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è - **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ

**–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É Prisma:**
   ```prisma
   model Session {
     id        String   @id @default(cuid())
     userId    String
     tokenHash String   @unique
     expiresAt DateTime
     createdAt DateTime @default(now())
     userAgent String?  // –ù–æ–≤–æ–µ –ø–æ–ª–µ
     ipAddress String?  // –ù–æ–≤–æ–µ –ø–æ–ª–µ
     
     user User @relation(fields: [userId], references: [id], onDelete: Cascade)
     
     @@index([userId])
     @@map("sessions")
   }
   ```

2. **–†–∞—Å—à–∏—Ä–∏—Ç—å SessionRepository:**
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ ID
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `deleteAllExcept()` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π

3. **–°–æ–∑–¥–∞—Ç—å UserService –º–µ—Ç–æ–¥—ã:**
   - `getUserSessions(userId: string)` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
   - `revokeSession(userId: string, sessionId: string)` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–µ—Å—Å–∏—é
   - `revokeOtherSessions(userId: string, currentTokenHash: string)` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π

4. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Ä–æ—É—Ç—ã:**
   - –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å—Ö–µ–º—ã

5. **–û–±–Ω–æ–≤–∏—Ç—å AuthService:**
   - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å User-Agent –∏ IP (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)

**–¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±—Ä–∞—É–∑–µ—Ä–µ/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –≤ —Å–µ—Å—Å–∏–∏
- –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± IP –∞–¥—Ä–µ—Å–µ
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–µ—Å—Å–∏—é

---

## üîí –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)

### ‚ùå –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: **–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- ‚ùå –ù–µ—Ç –º–æ–¥–µ–ª–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è 2FA —Å–µ–∫—Ä–µ—Ç–æ–≤
- ‚ùå –ù–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TOTP –∫–æ–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `otplib`, `speakeasy`)
- ‚ùå –ù–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è 2FA
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ 2FA –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- ‚ùå –ù–µ—Ç QR-–∫–æ–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–µ

### üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ 2FA

**1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
npm install otplib qrcode
npm install --save-dev @types/qrcode
```

**2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É Prisma:**
```prisma
model User {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  twoFactorSecret String?  // –°–µ–∫—Ä–µ—Ç –¥–ª—è TOTP (null –µ—Å–ª–∏ 2FA –≤—ã–∫–ª—é—á–µ–Ω)
  twoFactorEnabled Boolean @default(false)
  twoFactorBackupCodes String[] // –ú–∞—Å—Å–∏–≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
}
```

**3. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è 2FA:**
```typescript
// domain/user/TwoFactorService.ts
class TwoFactorService {
  generateSecret(): string
  generateQRCode(email: string, secret: string): Promise<string>
  verifyToken(secret: string, token: string): boolean
  generateBackupCodes(): string[]
}
```

**4. –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
- `POST /api/user/2fa/enable` - –≤–∫–ª—é—á–∏—Ç—å 2FA (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ç –∏ QR-–∫–æ–¥)
- `POST /api/user/2fa/verify` - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∫–ª—é—á–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥)
- `POST /api/user/2fa/disable` - –æ—Ç–∫–ª—é—á–∏—Ç—å 2FA (—Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—å)
- `POST /api/auth/login` - –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ 2FA –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞

**5. –û–±–Ω–æ–≤–∏—Ç—å AuthService:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ 2FA
- –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ - —Ç—Ä–µ–±–æ–≤–∞—Ç—å TOTP –∫–æ–¥
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —à–∞–≥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**6. Frontend:**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA —Å QR-–∫–æ–¥–æ–º
- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- –°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤ (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞)

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:**
- `otplib` - –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ TOTP –∫–æ–¥–æ–≤
- `qrcode` - –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–æ–≤
- `speakeasy` - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ otplib

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –°–µ–∫—Ä–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (–∏–ª–∏ —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è)
- –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
- –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ 2FA —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–º
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å 2FA

---

## üìù –†–µ–∑—é–º–µ

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å |
|---------|--------|-------------------|
| **–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ù–∏—á–µ–≥–æ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é —Å–µ—Å—Å–∏–π) |
| **–°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –ú–µ—Ç–æ–¥—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ User-Agent/IP |
| **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID, —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π |
| **2FA** | ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –Ω—É–ª—è |

---

## üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–í—ã—Å–æ–∫–∏–π:** –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (—Å–ø–∏—Å–æ–∫ + –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ) ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**
2. **–°—Ä–µ–¥–Ω–∏–π:** 2FA (–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è) ‚ö†Ô∏è **–í –ü–†–û–¶–ï–°–°–ï**
3. **–ù–∏–∑–∫–∏–π:** –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ—Å—Å–∏–π –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## ‚úÖ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### FLOW S1 & S2: –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ ‚Äî **–ó–ê–í–ï–†–®–ï–ù–û**

‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∞ –º–æ–¥–µ–ª—å Session (userAgent, ipAddress)  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –≤ SessionRepository  
‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã –≤ PrismaSessionRepository  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –≤ UserService  
‚úÖ –°–æ–∑–¥–∞–Ω—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Ä–æ—É—Ç—ã  
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω AuthService –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è userAgent/IP  

**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
- `GET /api/user/sessions` - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- `DELETE /api/user/sessions/:sessionId` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–µ—Å—Å–∏—é
- `DELETE /api/user/sessions/others` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π

### FLOW S3: 2FA ‚Äî **–í –ü–†–û–¶–ï–°–°–ï**

‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∞ –º–æ–¥–µ–ª—å User (twoFactorSecret, twoFactorEnabled, twoFactorBackupCodes)  
‚úÖ –°–æ–∑–¥–∞–Ω TwoFactorService  
‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ UserRepository –¥–ª—è 2FA  
‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ UserService –¥–ª—è 2FA  
‚ö†Ô∏è –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Ä–æ—É—Ç—ã –¥–ª—è 2FA  
‚ö†Ô∏è –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å AuthService –¥–ª—è –¥–≤—É—Ö—à–∞–≥–æ–≤–æ–≥–æ –ª–æ–≥–∏–Ω–∞  

**–¢—Ä–µ–±—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```bash
npm install otplib qrcode
npm install --save-dev @types/qrcode
```
