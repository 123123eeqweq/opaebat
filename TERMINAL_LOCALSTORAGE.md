# Terminal localStorage ‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

## üìã –û–±–∑–æ—Ä

–¢–µ—Ä–º–∏–Ω–∞–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `localStorage` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ ‚Äî –Ω–µ—Ç.

**–ö–ª—é—á –≤ localStorage:** `terminal.layout.v1`

---

## ‚úÖ –ß–¢–û –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø (–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)

### 1. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (Instrument)**
- **–ß—Ç–æ:** –í–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `EURUSD`, `GBPUSD`, `AUDCHF`)
- **–ì–¥–µ:** `layout.instrument`
- **–ö–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (debounce 1 —Å–µ–∫—É–Ω–¥–∞)
- **–ö–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –¥–æ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞)
- **–î–µ—Ñ–æ–ª—Ç:** `DEFAULT_INSTRUMENT_ID` (–∏–∑ `lib/instruments.ts`)

```typescript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
terminalLayoutRef.current.instrument = instrument;
saveLayoutDebounced(); // debounce 1 —Å–µ–∫—É–Ω–¥–∞

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
const savedLayout = loadLayoutFromLocalStorage();
if (savedLayout?.instrument) {
  setInstrument(savedLayout.instrument);
}
```

---

### 2. **–¢–∞–π–º—Ñ—Ä–µ–π–º (Timeframe)**
- **–ß—Ç–æ:** –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–≤–µ—á–µ–π (`5s`, `10s`, `15s`, `30s`, `1m`, `2m`, `3m`, `5m`, `10m`, `15m`, `30m`, `1h`, `4h`, `1d`)
- **–ì–¥–µ:** `layout.timeframe`
- **–ö–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ (debounce 1 —Å–µ–∫—É–Ω–¥–∞)
- **–ö–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `5s`
- **–î–µ—Ñ–æ–ª—Ç:** `5s`

```typescript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
terminalLayoutRef.current.timeframe = timeframe;
saveLayoutDebounced();

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
const validTimeframes = ['5s', '10s', '15s', ...];
const validTimeframe = validTimeframes.includes(savedLayout.timeframe)
  ? savedLayout.timeframe
  : '5s';
setTimeframe(validTimeframe);
```

---

### 3. **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (Indicators)**
- **–ß—Ç–æ:** –°–ø–∏—Å–æ–∫ –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- **–ì–¥–µ:** `layout.indicators[]`
- **–ö–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (–≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) (debounce 1 —Å–µ–∫—É–Ω–¥–∞)
- **–ö–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:**
  - `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
  - `params` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (period, periodD, stdDevMult, fastPeriod, slowPeriod, signalPeriod –∏ —Ç.–¥.)
  - `visible` ‚Äî –≤–∫–ª—é—á—ë–Ω –ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (enabled)
- **–í–∞–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ** –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (`c.enabled === true`)

```typescript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
terminalLayoutRef.current.indicators = indicatorConfigs
  .filter((c) => c.enabled) // –¢–æ–ª—å–∫–æ –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ!
  .map(indicatorConfigToLayout);
saveLayoutDebounced();

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
const allIndicators = getAllIndicators();
const restoredConfigs = allIndicators.map((indicator) => {
  const layoutIndicator = layout.indicators.find((li) => li.id === indicator.id);
  if (layoutIndicator) {
    return {
      ...indicator,
      ...layoutIndicatorToConfig(layoutIndicator, indicator.type),
    };
  }
  return indicator; // –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≤—ã–∫–ª—é—á–µ–Ω)
});
setIndicatorConfigs(restoredConfigs);
```

**–ü—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤:**
```json
{
  "indicators": [
    {
      "id": "sma-1",
      "params": { "period": 20 },
      "visible": true
    },
    {
      "id": "rsi-1",
      "params": { "period": 14 },
      "visible": true
    },
    {
      "id": "stochastic-1",
      "params": { "period": 14, "periodD": 3 },
      "visible": true
    }
  ]
}
```

---

### 4. **–†–∏—Å—É–Ω–∫–∏ (Drawings)**
- **–ß—Ç–æ:** –ù–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ (–ª–∏–Ω–∏–∏, –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏, —Ñ–∏–±–æ–Ω–∞—á—á–∏ –∏ —Ç.–¥.)
- **–ì–¥–µ:** `layout.drawings[]`
- **–ö–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∏—Å—É–Ω–∫–∞ (debounce 1 —Å–µ–∫—É–Ω–¥–∞)
- **–ö–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —Ç–∞–∫ –∫–∞–∫ –≥—Ä–∞—Ñ–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤)
- **–¢–∏–ø—ã —Ä–∏—Å—É–Ω–∫–æ–≤:**
  - `horizontal` ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
  - `vertical` ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
  - `trend` ‚Äî —Ç—Ä–µ–Ω–¥–æ–≤–∞—è –ª–∏–Ω–∏—è
  - `rectangle` ‚Äî –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
  - `fibonacci` ‚Äî —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏
  - `parallel-channel` ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª
  - `ray` ‚Äî –ª—É—á
  - `arrow` ‚Äî —Å—Ç—Ä–µ–ª–∫–∞

**–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∏—Å—É–Ω–∫–∞:**
- `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `type` ‚Äî —Ç–∏–ø —Ä–∏—Å—É–Ω–∫–∞
- `points` ‚Äî —Ç–æ—á–∫–∏ (–º–∞—Å—Å–∏–≤ `{ time: number; price: number }[]`)
- `color` ‚Äî —Ü–≤–µ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–µ—Ñ–æ–ª—Ç `#3347ff`)
- `offset` ‚Äî —Å–º–µ—â–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è `parallel-channel`)

```typescript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
if (candleChartRef.current) {
  const drawings = candleChartRef.current.getDrawings();
  terminalLayoutRef.current.drawings = drawings.map(drawingToLayout);
  saveLayoutDebounced();
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (—Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏, —Ç–∞–∫ –∫–∞–∫ –≥—Ä–∞—Ñ–∏–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤)
let attempts = 0;
const restoreDrawings = () => {
  if (candleChartRef.current) {
    candleChartRef.current.clearDrawings();
    layout.drawings.forEach((layoutDrawing) => {
      const drawing = layoutDrawingToDrawing(layoutDrawing);
      if (drawing) {
        candleChartRef.current?.addDrawing(drawing);
      }
    });
  } else if (attempts < 10) {
    setTimeout(restoreDrawings, 100); // –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 100ms
  }
};
setTimeout(restoreDrawings, 100);
```

**–ü—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∏—Å—É–Ω–∫–æ–≤:**
```json
{
  "drawings": [
    {
      "id": "drawing-1",
      "type": "horizontal",
      "points": [{ "time": 0, "price": 1.0850 }],
      "color": "#3347ff"
    },
    {
      "id": "drawing-2",
      "type": "trend",
      "points": [
        { "time": 1704067200000, "price": 1.0800 },
        { "time": 1704153600000, "price": 1.0900 }
      ],
      "color": "#ff4d4f"
    }
  ]
}
```

---

## ‚úÖ –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ (Chart Type) ‚Äî FLOW T-LS1
- **–ß—Ç–æ:** `'candles'` –∏–ª–∏ `'line'`
- **–ì–¥–µ:** `layout.chartType`
- **–ö–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (debounce 1 —Å–µ–∫—É–Ω–¥–∞)
- **–ö–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –≤ useState initializer)
- **–î–µ—Ñ–æ–ª—Ç:** `'candles'`
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ `'line'` –∏–ª–∏ `'candles'` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `'candles'`

```typescript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ localStorage
const [chartType, setChartType] = useState<ChartType>(() => {
  const raw = localStorage.getItem('terminal.layout.v1');
  if (!raw) return 'candles';
  try {
    const layout = JSON.parse(raw);
    return layout.chartType === 'line' ? 'line' : 'candles';
  } catch {
    return 'candles';
  }
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
const handleChartTypeChange = (type: ChartType) => {
  setChartType(type);
  terminalLayoutRef.current.chartType = type;
  saveLayoutDebounced();
};
```

---

## ‚úÖ –†–µ–∂–∏–º —Å–≤–µ—á–µ–π (Candle Mode) ‚Äî FLOW T-LS1
- **–ß—Ç–æ:** `'classic'`, `'heikin_ashi'`, `'bars'`
- **–ì–¥–µ:** `layout.candleMode`
- **–ö–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ —Å–≤–µ—á–µ–π (debounce 1 —Å–µ–∫—É–Ω–¥–∞)
- **–ö–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –≤ useState initializer)
- **–î–µ—Ñ–æ–ª—Ç:** `'classic'`
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `'classic'`

```typescript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ localStorage
const [candleMode, setCandleMode] = useState<CandleMode>(() => {
  const raw = localStorage.getItem('terminal.layout.v1');
  if (!raw) return 'classic';
  try {
    const layout = JSON.parse(raw);
    const allowed = ['classic', 'heikin_ashi', 'bars'];
    return allowed.includes(layout.candleMode)
      ? layout.candleMode
      : 'classic';
  } catch {
    return 'classic';
  }
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
const handleCandleModeChange = (mode: CandleMode) => {
  setCandleMode(mode);
  candleChartRef.current?.setCandleMode(mode);
  terminalLayoutRef.current.candleMode = mode;
  saveLayoutDebounced();
};
```

---

### 3. **Viewport (Pan/Zoom)**
- **–ß—Ç–æ:** –ü–æ–∑–∏—Ü–∏—è –∏ –º–∞—Å—à—Ç–∞–± –≥—Ä–∞—Ñ–∏–∫–∞
- **–ü–æ—á–µ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, –Ω–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:** –ì—Ä–∞—Ñ–∏–∫ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (follow mode)

---

### 2. **Follow Mode**
- **–ß—Ç–æ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Å–≤–µ—á–∞–º–∏
- **–î–µ—Ñ–æ–ª—Ç:** `true`
- **–ü–æ—á–µ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –°—á–∏—Ç–∞–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:** –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω

---

### 3. **Live-–¥–∞–Ω–Ω—ã–µ**
- **–ß—Ç–æ:** –¢–µ–∫—É—â–∏–µ —Å–≤–µ—á–∏, —Ü–µ–Ω—ã, —Ç–∏–∫–∏
- **–ü–æ—á–µ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –≠—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞
- **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:** –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API

---

### 4. **–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π**
- **–ß—Ç–æ:** –ê–Ω–∏–º–∞—Ç–æ—Ä—ã —Å–≤–µ—á–µ–π, –ø–µ—Ä–µ—Ö–æ–¥—ã
- **–ü–æ—á–µ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
- **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:** –í—Å–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è

---

### 5. **WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**
- **–ß—Ç–æ:** –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω
- **–ü–æ—á–µ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:** –ù–æ–≤–æ–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

---

### 6. **–¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- **–ß—Ç–æ:** –°—É–º–º–∞ —Å–¥–µ–ª–∫–∏ (`amount`), –≤—Ä–µ–º—è —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ (`time`), —Ç–∏–ø —Å—á—ë—Ç–∞ (`accountType`)
- **–ü–æ—á–µ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–¥–µ–ª–∫–∏
- **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:** –°–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º

---

### 7. **UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ**
- **–ß—Ç–æ:** –û—Ç–∫—Ä—ã—Ç—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞, –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ–Ω—é, hover —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **–ü–æ—á–µ–º—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:** –í—Å–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏

---

## üîÑ –ú–µ—Ö–∞–Ω–∏–∑–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

### Debounced Save (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π **1 —Å–µ–∫—É–Ω–¥–∞** (debounce), —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å localStorage —á–∞—Å—Ç—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏:

```typescript
const saveLayoutDebounced = useRef(
  debounce(() => {
    saveLayoutToLocalStorage(terminalLayoutRef.current);
  }, 1000)
).current;
```

### –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–æ–±—ã—Ç–∏–µ `beforeunload`) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:

```typescript
useEffect(() => {
  const handleBeforeUnload = () => {
    saveLayoutToLocalStorage(terminalLayoutRef.current);
  };
  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => {
    window.removeEventListener('beforeunload', handleBeforeUnload);
  };
}, []);
```

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage

```json
{
  "instrument": "EURUSD",
  "timeframe": "5s",
  "chartType": "line",
  "candleMode": "heikin_ashi",
  "indicators": [
    {
      "id": "sma-1",
      "params": { "period": 20 },
      "visible": true
    }
  ],
  "drawings": [
    {
      "id": "drawing-1",
      "type": "horizontal",
      "points": [{ "time": 0, "price": 1.0850 }],
      "color": "#3347ff"
    }
  ]
}
```

---

## üöÄ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

1. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ instrument** (–¥–æ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞):
   ```typescript
   const [instrument, setInstrument] = useState<string>(() => {
     const raw = localStorage.getItem('terminal.layout.v1');
     if (raw) {
       const layout = JSON.parse(raw);
       return layout.instrument || DEFAULT_INSTRUMENT_ID;
     }
     return DEFAULT_INSTRUMENT_ID;
   });
   ```

2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫** (–≤ `useEffect` –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏):
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è `timeframe`
   - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è `indicators`
   - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è `drawings` (—Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏, —Ç–∞–∫ –∫–∞–∫ –≥—Ä–∞—Ñ–∏–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤)

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `instrument` ‚Äî —Å—Ç—Ä–æ–∫–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `timeframe` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `indicators` –∏ `drawings` ‚Äî –º–∞—Å—Å–∏–≤—ã

---

## üîß –§–∞–π–ª—ã, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ localStorage

- **`frontend/lib/terminalLayout.ts`** ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤
- **`frontend/app/terminal/page.tsx`** ‚Äî –ª–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å localStorage

---

## üí° –†–µ–∑—é–º–µ

**–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:**
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–≤–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞)
- ‚úÖ –¢–∞–π–º—Ñ—Ä–µ–π–º
- ‚úÖ –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ (—Å–≤–µ—á–∏/–ª–∏–Ω–∏—è) ‚Äî **FLOW T-LS1**
- ‚úÖ –†–µ–∂–∏–º —Å–≤–µ—á–µ–π (Classic/Heikin Ashi/Bars) ‚Äî **FLOW T-LS1**
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
- ‚úÖ –†–∏—Å—É–Ω–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ

**–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:**
- ‚ùå Viewport (pan/zoom)
- ‚ùå Follow mode
- ‚ùå Live-–¥–∞–Ω–Ω—ã–µ
- ‚ùå –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- ‚ùå UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ú–µ—Ö–∞–Ω–∏–∑–º:** Debounced save (1 —Å–µ–∫—É–Ω–¥–∞) + —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
