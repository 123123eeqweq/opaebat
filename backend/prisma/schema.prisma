// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // FLOW U1: Base Profile fields
  firstName   String?
  lastName    String?
  nickname    String?   @unique
  phone       String?   @unique
  country     String?
  dateOfBirth DateTime?
  avatarUrl   String?

  // üî• FLOW S3: Two-Factor Authentication
  twoFactorSecret    String?
  twoFactorEnabled   Boolean  @default(false)
  twoFactorBackupCodes String[] // Array of hashed backup codes

  sessions     Session[]
  accounts     Account[]
  trades       Trade[]
  transactions Transaction[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // üî• FLOW S1: Session metadata for UI
  userAgent String?
  ipAddress String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

enum AccountType {
  demo
  real
}

model Account {
  id        String      @id @default(cuid())
  userId    String
  type      AccountType
  balance   Decimal     @default(0)
  currency  String      @default("UAH")
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades       Trade[]
  transactions Transaction[]

  @@unique([userId, type])
  @@index([userId])
  @@map("accounts")
}

enum TradeDirection {
  CALL
  PUT
}

enum TradeStatus {
  OPEN
  WIN
  LOSS
  TIE // –ù–∏—á—å—è: exitPrice === entryPrice ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏
}

model Trade {
  id         String         @id @default(uuid())
  userId     String
  accountId  String
  direction  TradeDirection
  instrument String // Trading instrument (e.g., 'AUDCHF', 'BTCUSD')
  amount     Decimal
  entryPrice Decimal
  exitPrice  Decimal?
  payout     Decimal
  status     TradeStatus
  openedAt   DateTime       @default(now())
  expiresAt  DateTime
  closedAt   DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([status, expiresAt])
  @@index([userId])
  @@index([accountId])
  @@index([instrument])
  @@map("trades")
}

// –°–≤–µ—á–∏ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫ ‚Äî —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –ø–æ—Å—Ç–æ—è–Ω–Ω–æ (–Ω–µ –≤ Redis)
model Candle {
  id        String  @id @default(cuid())
  symbol    String  @default("BTC/USD")
  timeframe String // '5s'
  timestamp BigInt // –Ω–∞—á–∞–ª–æ —Å–≤–µ—á–∏, ms
  open      Decimal
  high      Decimal
  low       Decimal
  close     Decimal

  @@unique([symbol, timeframe, timestamp])
  @@index([symbol, timeframe, timestamp(sort: Desc)])
  @@map("candles")
}

// Price Points –¥–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ ‚Äî 1 —Ç–æ—á–∫–∞ –≤ —Å–µ–∫—É–Ω–¥—É
model PricePoint {
  id        String  @id @default(cuid())
  symbol    String
  timestamp BigInt // –Ω–∞—á–∞–ª–æ —Å–µ–∫—É–Ω–¥—ã (ms), Math.floor(time / 1000) * 1000
  price     Decimal

  @@unique([symbol, timestamp])
  @@index([symbol, timestamp(sort: Desc)])
  @@map("price_points")
}

// üî• FLOW W1: Transaction model for deposits/withdrawals
enum TransactionType {
  DEPOSIT
  WITHDRAW
  TRADE_RESULT
  BONUS
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum PaymentMethod {
  CARD
  CRYPTO
  BANK
  APPLE_PAY
  GOOGLE_PAY
  PAYPAL
  QIWI
  YOOMONEY
  WEBMONEY
  SKRILL
  NETELLER
  ADVANCED_CASH
  SBP
}

model Transaction {
  id        String @id @default(uuid())
  userId    String
  accountId String

  type   TransactionType
  status TransactionStatus

  amount   Decimal @db.Decimal(18, 2)
  currency String // "USD"

  paymentMethod PaymentMethod
  provider      String? // stripe / crypto / manual

  createdAt   DateTime  @default(now())
  confirmedAt DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([status])
  @@map("transactions")
}

// üî• FLOW I-PAYOUT: Instrument model –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
model Instrument {
  id           String   @id // 'EURUSD', 'GBPUSD', 'AUDCHF_REAL', etc.
  name         String   // Display name: 'EUR / USD', 'GBP / USD'
  base         String   // 'EUR', 'GBP', 'USD'
  quote        String   // 'USD', 'JPY', 'CHF'
  isActive     Boolean  @default(true)
  payoutPercent Int     @default(75) // 60‚Äì90%
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("instruments")
}
