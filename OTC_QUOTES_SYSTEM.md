# ะกะธััะตะผะฐ OTC ะบะพัะธัะพะฒะพะบ (Over The Counter)

## ๐ ะกะพะดะตัะถะฐะฝะธะต

1. [ะงัะพ ัะฐะบะพะต OTC ะบะพัะธัะพะฒะบะธ](#ััะพ-ัะฐะบะพะต-otc-ะบะพัะธัะพะฒะบะธ)
2. [ะััะธัะตะบัััะฐ ัะธััะตะผั](#ะฐััะธัะตะบัััะฐ-ัะธััะตะผั)
3. [ะะตะฝะตัะฐัะธั ัะตะฝ](#ะณะตะฝะตัะฐัะธั-ัะตะฝ)
4. [ะะพะฝัะธะณััะฐัะธั ะธะฝััััะผะตะฝัะพะฒ](#ะบะพะฝัะธะณััะฐัะธั-ะธะฝััััะผะตะฝัะพะฒ)
5. [ะะพัะพะบ ะดะฐะฝะฝัั](#ะฟะพัะพะบ-ะดะฐะฝะฝัั)
6. [ะฅัะฐะฝะตะฝะธะต ะดะฐะฝะฝัั](#ััะฐะฝะตะฝะธะต-ะดะฐะฝะฝัั)
7. [ะะฝัะตะณัะฐัะธั ั WebSocket](#ะธะฝัะตะณัะฐัะธั-ั-websocket)
8. [ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฝะฐ ััะพะฝัะตะฝะดะต](#ะธัะฟะพะปัะทะพะฒะฐะฝะธะต-ะฝะฐ-ััะพะฝัะตะฝะดะต)

---

## ะงัะพ ัะฐะบะพะต OTC ะบะพัะธัะพะฒะบะธ

### ะะฟัะตะดะตะปะตะฝะธะต

**OTC (Over The Counter)** โ ััะพ ะบะพัะธัะพะฒะบะธ, ะบะพัะพััะต ะณะตะฝะตัะธัััััั **ะฒะฝัััะธ ัะธััะตะผั**, ะฐ ะฝะต ะฟะพะปััะฐัััั ะธะท ะฒะฝะตัะฝะธั ะธััะพัะฝะธะบะพะฒ (ะฑะธัะถะธ, ะฑัะพะบะตัั).

### ะะฐัะตะผ ะฝัะถะฝั OTC ะบะพัะธัะพะฒะบะธ?

1. **ะะตะทะฐะฒะธัะธะผะพััั ะพั ะฒะฝะตัะฝะธั API**: ะะต ะฝัะถะฝะพ ะฟะพะดะบะปััะฐัััั ะบ ัะตะฐะปัะฝัะผ ะฑะธัะถะฐะผ
2. **ะะพะฝััะพะปั**: ะะพะปะฝัะน ะบะพะฝััะพะปั ะฝะฐะด ะณะตะฝะตัะฐัะธะตะน ัะตะฝ
3. **ะขะตััะธัะพะฒะฐะฝะธะต**: ะะตะณะบะพ ัะตััะธัะพะฒะฐัั ัะพัะณะพะฒัะต ัััะฐัะตะณะธะธ
4. **ะะตะผะพ-ัะตะถะธะผ**: ะะดะตะฐะปัะฝะพ ะดะปั ะดะตะผะพ-ััะตัะพะฒ
5. **ะกัะฐะฑะธะปัะฝะพััั**: ะะตั ะทะฐะฒะธัะธะผะพััะธ ะพั ะฒะฝะตัะฝะธั ัะตัะฒะธัะพะฒ

### ะัะปะธัะธั ะพั ัะตะฐะปัะฝัั ะบะพัะธัะพะฒะพะบ

| ะะฐัะฐะผะตัั | ะะตะฐะปัะฝัะต ะบะพัะธัะพะฒะบะธ | OTC ะบะพัะธัะพะฒะบะธ |
|----------|-------------------|---------------|
| **ะััะพัะฝะธะบ** | ะะธัะถะฐ/ะฑัะพะบะตั | ะะปะณะพัะธัะผ ะณะตะฝะตัะฐัะธะธ |
| **ะะพะปะฐัะธะปัะฝะพััั** | ะะตะฐะปัะฝะฐั ััะฝะพัะฝะฐั | ะะพะฝััะพะปะธััะตะผะฐั |
| **ะะพัััะฟะฝะพััั** | ะะฐะฒะธัะธั ะพั API | ะัะตะณะดะฐ ะดะพัััะฟะฝั |
| **ะกัะพะธะผะพััั** | ะะปะฐัะฝัะต API | ะะตัะฟะปะฐัะฝะพ |

---

## ะััะธัะตะบัััะฐ ัะธััะตะผั

### ะะพะผะฟะพะฝะตะฝัั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PriceEngineManager                       โ
โ  (ะัะบะตัััะฐัะพั ะฒัะตั engines ะดะปั ะฒัะตั ะธะฝััััะผะตะฝัะพะฒ)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
        โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโ
        โ                 โ                 โ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ OtcPriceEngine โ  โ CandleEngine โ  โ TimeframeAggregator โ
โ (ะณะตะฝะตัะฐัะธั ัะตะฝ) โ  โ (5s ัะฒะตัะธ)   โ  โ (ะฐะณัะตะณะฐัะธั)        โ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
        โ                 โ                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PriceEventBus                            โ
โ  (Event-driven ะฐััะธัะตะบัััะฐ ะดะปั ัะฒัะทะธ ะบะพะผะฟะพะฝะตะฝัะพะฒ)          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ                 โ                 โ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ PriceStore   โ  โ CandleStore  โ  โ PricePointWriter โ
โ (Redis)      โ  โ (PostgreSQL) โ  โ (PostgreSQL)      โ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              WebSocket Bootstrap                            โ
โ  (ะะพััะฐะฒะบะฐ ัะตะฝ ะบะปะธะตะฝัะฐะผ ัะตัะตะท WebSocket)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะปััะตะฒัะต ะฟัะธะฝัะธะฟั

1. **Multi-instrument**: ะะดะธะฝ `PriceEngineManager` ัะฟัะฐะฒะปัะตั ะฒัะตะผะธ ะธะฝััััะผะตะฝัะฐะผะธ
2. **Event-driven**: ะะพะผะฟะพะฝะตะฝัั ะพะฑัะฐัััั ัะตัะตะท `PriceEventBus`
3. **Separation of concerns**: ะะฐะถะดัะน ะบะพะผะฟะพะฝะตะฝั ะพัะฒะตัะฐะตั ะทะฐ ัะฒะพั ะทะฐะดะฐัั
4. **In-memory + Persistent**: ะขะตะบััะธะต ัะตะฝั ะฒ Redis, ะธััะพัะธั ะฒ PostgreSQL

---

## ะะตะฝะตัะฐัะธั ัะตะฝ

### ะะปะณะพัะธัะผ: Controlled Random Walk

**ะคะฐะนะป**: `backend/src/prices/engines/OtcPriceEngine.ts`

#### ะัะธะฝัะธะฟ ัะฐะฑะพัั

```typescript
// 1. ะะตะฝะตัะธััะตะผ ัะปััะฐะนะฝะพะต ะธะทะผะตะฝะตะฝะธะต ะฒ ะฟัะตะดะตะปะฐั ะฒะพะปะฐัะธะปัะฝะพััะธ
const changePercent = (Math.random() - 0.5) * 2 * volatility;
// ะะธะฐะฟะฐะทะพะฝ: [-volatility, +volatility]

// 2. ะััะธัะปัะตะผ ะธะทะผะตะฝะตะฝะธะต ัะตะฝั
const change = currentPrice * changePercent;

// 3. ะัะธะผะตะฝัะตะผ ะธะทะผะตะฝะตะฝะธะต
let newPrice = currentPrice + change;

// 4. ะะณัะฐะฝะธัะธะฒะฐะตะผ ะณัะฐะฝะธัะฐะผะธ (minPrice, maxPrice)
if (newPrice < minPrice) newPrice = minPrice;
if (newPrice > maxPrice) newPrice = maxPrice;
```

#### ะะฐัะฐะผะตััั ะณะตะฝะตัะฐัะธะธ

| ะะฐัะฐะผะตัั | ะะฟะธัะฐะฝะธะต | ะัะธะผะตั |
|----------|----------|--------|
| **initialPrice** | ะะฐัะฐะปัะฝะฐั ัะตะฝะฐ | `1.08` (EUR/USD) |
| **minPrice** | ะะธะฝะธะผะฐะปัะฝะฐั ัะตะฝะฐ | `0.95` |
| **maxPrice** | ะะฐะบัะธะผะฐะปัะฝะฐั ัะตะฝะฐ | `1.25` |
| **volatility** | ะะพะปะฐัะธะปัะฝะพััั (0-1) | `0.0002` (0.02%) |
| **tickInterval** | ะะฝัะตัะฒะฐะป ะณะตะฝะตัะฐัะธะธ (ะผั) | `500` (2 ัะธะบะฐ/ัะตะบ) |

#### ะงะฐััะพัะฐ ะณะตะฝะตัะฐัะธะธ

- **ะะฝัะตัะฒะฐะป**: 400-600 ะผั (ะพะฑััะฝะพ 500 ะผั)
- **ะงะฐััะพัะฐ**: ~2 ัะธะบะฐ ะฒ ัะตะบัะฝะดั
- **ะะฐ ะดะตะฝั**: ~172,800 ัะธะบะพะฒ ะฝะฐ ะธะฝััััะผะตะฝั

#### ะัะธะผะตั ะณะตะฝะตัะฐัะธะธ

```
ะะฐัะฐะปัะฝะฐั ัะตะฝะฐ: 1.08000
ะะพะปะฐัะธะปัะฝะพััั: 0.0002 (0.02%)

ะขะธะบ 1: changePercent = 0.0001 โ change = 0.000108 โ price = 1.080108
ะขะธะบ 2: changePercent = -0.00015 โ change = -0.000162 โ price = 1.079946
ะขะธะบ 3: changePercent = 0.0002 โ change = 0.000216 โ price = 1.080162
...
```

### ะะณัะฐะฝะธัะตะฝะธั

1. **ะัะฐะฝะธัั**: ะฆะตะฝะฐ ะฒัะตะณะดะฐ ะฒ ะดะธะฐะฟะฐะทะพะฝะต `[minPrice, maxPrice]`
2. **ะะพะปะฐัะธะปัะฝะพััั**: ะะทะผะตะฝะตะฝะธะต ะฝะต ะฟัะตะฒััะฐะตั `volatility * currentPrice`
3. **ะะตะฐะปะธััะธัะฝะพััั**: ะะปะณะพัะธัะผ ะธะผะธัะธััะตั ัะปััะฐะนะฝะพะต ะฑะปัะถะดะฐะฝะธะต (random walk)

---

## ะะพะฝัะธะณััะฐัะธั ะธะฝััััะผะตะฝัะพะฒ

### ะคะฐะนะป: `backend/src/config/instruments.ts`

### ะกัััะบัััะฐ ะบะพะฝัะธะณััะฐัะธะธ

```typescript
interface InstrumentConfig {
  id: string;              // "EURUSD", "BTCUSD"
  base: string;             // "EUR", "BTC"
  quote: string;           // "USD"
  digits: number;           // ะขะพัะฝะพััั ะพัะพะฑัะฐะถะตะฝะธั (5 ะดะปั Forex, 2 ะดะปั ะบัะธะฟัั)
  engine: {
    asset: string;          // "EUR/USD", "BTC/USD"
    initialPrice: number;   // ะะฐัะฐะปัะฝะฐั ัะตะฝะฐ
    minPrice: number;       // ะะธะฝะธะผะฐะปัะฝะฐั ัะตะฝะฐ
    maxPrice: number;       // ะะฐะบัะธะผะฐะปัะฝะฐั ัะตะฝะฐ
    volatility: number;     // ะะพะปะฐัะธะปัะฝะพััั (0-1)
    tickInterval: number;   // ะะฝัะตัะฒะฐะป ะณะตะฝะตัะฐัะธะธ (ะผั)
  };
}
```

### ะะพัััะฟะฝัะต ะธะฝััััะผะตะฝัั

#### Forex ะฟะฐัั (17 ะธะฝััััะผะตะฝัะพะฒ)

| ID | ะะฐัะฐ | ะะฐัะฐะปัะฝะฐั ัะตะฝะฐ | ะะธะฐะฟะฐะทะพะฝ | ะะพะปะฐัะธะปัะฝะพััั |
|----|------|----------------|----------|---------------|
| EURUSD | EUR/USD | 1.08 | 0.95-1.25 | 0.0002 |
| GBPUSD | GBP/USD | 1.27 | 1.0-1.5 | 0.0002 |
| USDCAD | USD/CAD | 1.36 | 1.2-1.5 | 0.0002 |
| USDCHF | USD/CHF | 0.88 | 0.8-1.0 | 0.0002 |
| AUDCAD | AUD/CAD | 0.88 | 0.8-1.0 | 0.0002 |
| AUDCHF | AUD/CHF | 0.57 | 0.5-0.65 | 0.0002 |
| CADJPY | CAD/JPY | 110 | 95-125 | 0.0002 |
| EURJPY | EUR/JPY | 165 | 140-175 | 0.0002 |
| GBPJPY | GBP/JPY | 200 | 165-220 | 0.0002 |
| NZDUSD | NZD/USD | 0.61 | 0.52-0.72 | 0.0002 |
| NZDJPY | NZD/JPY | 97 | 82-110 | 0.0002 |
| EURCHF | EUR/CHF | 0.95 | 0.88-1.02 | 0.0002 |
| EURNZD | EUR/NZD | 1.75 | 1.55-1.95 | 0.0002 |
| GBPAUD | GBP/AUD | 1.95 | 1.7-2.2 | 0.0002 |
| CHFNOK | CHF/NOK | 12.0 | 10.5-13.5 | 0.0002 |
| UAHUSD | UAH/USD | 0.025 | 0.02-0.03 | 0.0002 |

#### ะัะธะฟัะพะฒะฐะปััั (4 ะธะฝััััะผะตะฝัะฐ)

| ID | ะะฐัะฐ | ะะฐัะฐะปัะฝะฐั ัะตะฝะฐ | ะะธะฐะฟะฐะทะพะฝ | ะะพะปะฐัะธะปัะฝะพััั |
|----|------|----------------|----------|---------------|
| BTCUSD | BTC/USD | 50000 | 30000-70000 | 0.001 |
| ETHUSD | ETH/USD | 3000 | 2000-4500 | 0.001 |
| SOLUSD | SOL/USD | 150 | 80-250 | 0.0015 |
| BNBUSD | BNB/USD | 600 | 400-800 | 0.001 |

### ะัะพะฑะตะฝะฝะพััะธ ะบะพะฝัะธะณััะฐัะธะธ

1. **Forex**: ะะธะทะบะฐั ะฒะพะปะฐัะธะปัะฝะพััั (0.0002 = 0.02%), ะฒััะพะบะฐั ัะพัะฝะพััั (5 ะทะฝะฐะบะพะฒ)
2. **ะัะธะฟัะพะฒะฐะปััั**: ะััะพะบะฐั ะฒะพะปะฐัะธะปัะฝะพััั (0.001-0.0015 = 0.1-0.15%), ะฝะธะทะบะฐั ัะพัะฝะพััั (2 ะทะฝะฐะบะฐ)
3. **ะะธะฐะฟะฐะทะพะฝั**: ะะตะฐะปะธััะธัะฝัะต ะดะธะฐะฟะฐะทะพะฝั ัะตะฝ ะดะปั ะบะฐะถะดะพะณะพ ะธะฝััััะผะตะฝัะฐ
4. **ะะฐัะฐะปัะฝัะต ัะตะฝั**: ะะปะธะทะบะธ ะบ ัะตะฐะปัะฝัะผ ััะฝะพัะฝัะผ ัะตะฝะฐะผ

---

## ะะพัะพะบ ะดะฐะฝะฝัั

### 1. ะะตะฝะตัะฐัะธั ัะธะบะฐ

```
OtcPriceEngine.generateTick()
  โ
  ะััะธัะปัะตั ะฝะพะฒัั ัะตะฝั (controlled random walk)
  โ
  ะกะพะทะดะฐะตั PriceTick { price, timestamp }
  โ
  ะกะพััะฐะฝัะตั ะฒ PriceStore (Redis)
  โ
  ะญะผะธัะธั ัะพะฑััะธะต 'price_tick' ัะตัะตะท PriceEventBus
```

### 2. ะะฑัะฐะฑะพัะบะฐ ัะธะบะฐ

```
PriceEventBus.emit('price_tick')
  โ
  โโโ CandleEngine.handlePriceTick()
  โ     โ
  โ     ะะณัะตะณะธััะตั ัะธะบะธ ะฒ 5s ัะฒะตัะธ
  โ     โ
  โ     ะญะผะธัะธั 'candle_opened', 'candle_updated', 'candle_closed'
  โ
  โโโ PricePointWriter.handleTick()
  โ     โ
  โ     ะะฐะฟะธััะฒะฐะตั 1 ัะพัะบั ะฒ ัะตะบัะฝะดั ะฒ PostgreSQL (price_points)
  โ
  โโโ WebSocket Bootstrap
        โ
        ะัะฟัะฐะฒะปัะตั 'price:update' ะบะปะธะตะฝัะฐะผ ัะตัะตะท WebSocket
```

### 3. ะะณัะตะณะฐัะธั ะฒ ัะฒะตัะธ

```
CandleEngine.handlePriceTick()
  โ
  ะััะธัะปัะตั ัะปะพั ะฒัะตะผะตะฝะธ (5 ัะตะบัะฝะด)
  โ
  ะัะปะธ ะฝะพะฒะฐั ัะฒะตัะฐ โ ะพัะบััะฒะฐะตั
  ะัะปะธ ะพะฑะฝะพะฒะปะตะฝะธะต โ ะพะฑะฝะพะฒะปัะตั high/low/close
  ะัะปะธ ัะปะพั ะทะฐะบะพะฝัะธะปัั โ ะทะฐะบััะฒะฐะตั ัะฒะตัั
  โ
  ะกะพััะฐะฝัะตั ะฒ CandleStore (PostgreSQL)
  โ
  ะญะผะธัะธั 'candle_closed' โ TimeframeAggregator
```

### 4. ะะณัะตะณะฐัะธั ัะฐะนะผััะตะนะผะพะฒ

```
TimeframeAggregator
  โ
  ะะพะดะฟะธััะฒะฐะตััั ะฝะฐ 'candle_closed' (5s)
  โ
  ะะณัะตะณะธััะตั 5s ัะฒะตัะธ ะฒ:
    - 10s, 15s, 30s, 1m, 2m, 3m, 5m
    - 10m, 15m, 30m, 1h, 4h, 1d
  โ
  ะกะพััะฐะฝัะตั ะฒ CandleStore (PostgreSQL)
  โ
  ะญะผะธัะธั 'candle_closed' ะดะปั ะบะฐะถะดะพะณะพ ัะฐะนะผััะตะนะผะฐ
```

---

## ะฅัะฐะฝะตะฝะธะต ะดะฐะฝะฝัั

### 1. ะขะตะบััะธะต ัะตะฝั (Redis)

**ะคะฐะนะป**: `backend/src/prices/store/PriceStore.ts`

- **ะะปัั**: `price:${instrumentId}` (ะฝะฐะฟัะธะผะตั, `price:EURUSD`)
- **ะะฝะฐัะตะฝะธะต**: `{ price: number, timestamp: number }` (JSON)
- **TTL**: ะะตั (ะพะฑะฝะพะฒะปัะตััั ะฟะพััะพัะฝะฝะพ)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะัััััะน ะดะพัััะฟ ะบ ัะตะบััะตะน ัะตะฝะต

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต**:
- API endpoint `/api/terminal/snapshot` โ ะฟะพะปััะตะฝะธะต ัะตะบััะตะน ัะตะฝั
- ะัััััะน ะดะพัััะฟ ะฑะตะท ะทะฐะฟัะพัะพะฒ ะบ ะะ

### 2. ะกะฒะตัะธ (PostgreSQL)

**ะขะฐะฑะปะธัะฐ**: `candles`

```prisma
model Candle {
  id        String  @id @default(cuid())
  symbol    String  // "BTC/USD", "EUR/USD"
  timeframe String  // "5s", "1m", "1h"
  timestamp BigInt  // ะะฐัะฐะปะพ ัะฒะตัะธ (ะผั)
  open      Decimal
  high      Decimal
  low       Decimal
  close     Decimal
  
  @@unique([symbol, timeframe, timestamp])
  @@index([symbol, timeframe, timestamp(sort: Desc)])
}
```

**ะะฐะทะฝะฐัะตะฝะธะต**:
- ะััะพัะธั ะดะปั ัะฒะตัะฝะพะณะพ ะณัะฐัะธะบะฐ
- ะะฝะดะธะบะฐัะพัั (SMA, EMA, RSI, Bollinger Bands ะธ ั.ะด.)
- API endpoints ะดะปั ะทะฐะณััะทะบะธ ะธััะพัะธะธ

### 3. Price Points (PostgreSQL)

**ะขะฐะฑะปะธัะฐ**: `price_points`

```prisma
model PricePoint {
  id        String  @id @default(cuid())
  symbol    String  // "BTC/USD", "EUR/USD"
  timestamp BigInt  // ะะฐัะฐะปะพ ัะตะบัะฝะดั (ะผั)
  price     Decimal
  
  @@unique([symbol, timestamp])
  @@index([symbol, timestamp(sort: Desc)])
}
```

**ะะฐะทะฝะฐัะตะฝะธะต**:
- ะััะพัะธั ะดะปั ะปะธะฝะตะนะฝะพะณะพ ะณัะฐัะธะบะฐ
- 1 ัะพัะบะฐ ะฒ ัะตะบัะฝะดั (ะฝะต ะบะฐะถะดัะน ัะธะบ!)
- API endpoints `/api/line/snapshot` ะธ `/api/line/history`

---

## ะะฝัะตะณัะฐัะธั ั WebSocket

### ะคะฐะนะป: `backend/src/bootstrap/websocket.bootstrap.ts`

### ะกะพะฑััะธั, ะพัะฟัะฐะฒะปัะตะผัะต ะบะปะธะตะฝัะฐะผ

#### 1. `price:update` (ะบะฐะถะดัะน ัะธะบ)

```typescript
{
  instrument: "EURUSD",
  type: "price:update",
  data: {
    asset: "EURUSD",
    price: 1.08012,
    timestamp: 1769731845123
  }
}
```

**ะงะฐััะพัะฐ**: ~2 ัะฐะทะฐ ะฒ ัะตะบัะฝะดั (ะบะฐะถะดัะน ัะธะบ)

**ะะพะดะฟะธัะบะฐ**: ะะปะธะตะฝั ะดะพะปะถะตะฝ ะฟะพะดะฟะธัะฐัััั ะฝะฐ ะธะฝััััะผะตะฝั:
```typescript
ws.send({ type: 'subscribe', instrument: 'EURUSD' });
```

#### 2. `candle:update` (ะพะฑะฝะพะฒะปะตะฝะธะต ะถะธะฒะพะน ัะฒะตัะธ)

```typescript
{
  instrument: "EURUSD",
  type: "candle:update",
  data: {
    timeframe: "5s",
    candle: {
      open: 1.08000,
      high: 1.08050,
      low: 1.07980,
      close: 1.08030,
      timestamp: 1769731845000,
      timeframe: "5s"
    }
  }
}
```

**ะงะฐััะพัะฐ**: ะัะธ ะบะฐะถะดะพะผ ัะธะบะต, ะตัะปะธ ัะฒะตัะฐ ะตัะต ะพัะบัััะฐ

#### 3. `candle:close` (ะทะฐะบัััะธะต ัะฒะตัะธ)

```typescript
{
  instrument: "EURUSD",
  type: "candle:close",
  data: {
    timeframe: "5s",
    candle: {
      open: 1.08000,
      high: 1.08050,
      low: 1.07980,
      close: 1.08030,
      timestamp: 1769731845000,
      timeframe: "5s"
    }
  }
}
```

**ะงะฐััะพัะฐ**: ะะฐะถะดัะต 5 ัะตะบัะฝะด (ะดะปั ะฑะฐะทะพะฒะพะณะพ ัะฐะนะผััะตะนะผะฐ)

#### 4. `server:time` (ัะธะฝััะพะฝะธะทะฐัะธั ะฒัะตะผะตะฝะธ)

```typescript
{
  type: "server:time",
  data: {
    timestamp: 1769731845123
  }
}
```

**ะงะฐััะพัะฐ**: ะะฐะถะดัั ัะตะบัะฝะดั (ะดะปั ะฒัะตั ะบะปะธะตะฝัะพะฒ)

### ะะพะดะฟะธัะบะฐ ะฝะฐ ะธะฝััััะผะตะฝัั

**ะะปะธะตะฝั ะฟะพะดะฟะธััะฒะฐะตััั**:
```typescript
ws.send({ type: 'subscribe', instrument: 'EURUSD' });
ws.send({ type: 'subscribe', instrument: 'BTCUSD' });
```

**ะกะตัะฒะตั ะพัะฟัะฐะฒะปัะตั**:
```typescript
{ type: 'subscribed', instrument: 'EURUSD' }
```

**ะัะฟะธัะบะฐ**:
```typescript
ws.send({ type: 'unsubscribe', instrument: 'EURUSD' });
ws.send({ type: 'unsubscribe_all' });
```

### ะคะธะปัััะฐัะธั ะฟะพ ะธะฝััััะผะตะฝัะฐะผ

**ะะฐะถะฝะพ**: ะกะตัะฒะตั ะพัะฟัะฐะฒะปัะตั ัะพะฑััะธั **ัะพะปัะบะพ ะฟะพะดะฟะธัะฐะฝะฝัะผ ะบะปะธะตะฝัะฐะผ**.

```typescript
// ะะปะธะตะฝั ะฟะพะดะฟะธัะฐะฝ ัะพะปัะบะพ ะฝะฐ EURUSD
ws.send({ type: 'subscribe', instrument: 'EURUSD' });

// ะกะตัะฒะตั ะพัะฟัะฐะฒะปัะตั ัะพะปัะบะพ EURUSD ัะพะฑััะธั
// BTCUSD ัะพะฑััะธั ะะ ะพัะฟัะฐะฒะปััััั
```

---

## ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฝะฐ ััะพะฝัะตะฝะดะต

### WebSocket ะฟะพะดะบะปััะตะฝะธะต

**ะคะฐะนะป**: `frontend/lib/hooks/useWebSocket.ts`

```typescript
useWebSocket({
  activeInstrumentRef,  // ะขะตะบััะธะน ะฐะบัะธะฒะฝัะน ะธะฝััััะผะตะฝั
  onPriceUpdate: (price, timestamp) => {
    // ะะฑะฝะพะฒะปะตะฝะธะต ัะตะฝั ะดะปั ะปะธะฝะตะนะฝะพะณะพ ะณัะฐัะธะบะฐ
  },
  onServerTime: (timestamp) => {
    // ะกะธะฝััะพะฝะธะทะฐัะธั ะฒัะตะผะตะฝะธ ัะตัะฒะตัะฐ
  },
  onTradeClose: (tradeId) => {
    // ะะฐะบัััะธะต ัะดะตะปะบะธ
  },
});
```

### ะะฑัะฐะฑะพัะบะฐ ัะพะฑััะธะน

#### 1. ะกะฒะตัะฝะพะน ะณัะฐัะธะบ

```typescript
// ะะพะดะฟะธัะบะฐ ะฝะฐ candle:close
ws.on('candle:close', (event) => {
  if (event.instrument === activeInstrument) {
    // ะะพะฑะฐะฒะปัะตะผ ัะฒะตัั ะฝะฐ ะณัะฐัะธะบ
    chart.addCandle(event.data.candle);
  }
});
```

#### 2. ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ

```typescript
// ะะพะดะฟะธัะบะฐ ะฝะฐ price:update
ws.on('price:update', (event) => {
  if (event.instrument === activeInstrument) {
    // ะะฑะฝะพะฒะปัะตะผ live ัะตะณะผะตะฝั
    lineChart.handlePriceUpdate(event.data.price, event.data.timestamp);
  }
});
```

### ะะพะปััะตะฝะธะต snapshot

**ะัะธ ะทะฐะณััะทะบะต ัััะฐะฝะธัั**:

```typescript
// ะกะฒะตัะฝะพะน ะณัะฐัะธะบ
const snapshot = await api('/api/terminal/snapshot?instrument=EURUSD');
// ะะพะทะฒัะฐัะฐะตั: { candles: [...], currentPrice: {...}, serverTime: ... }

// ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ
const snapshot = await api('/api/line/snapshot?symbol=EURUSD');
// ะะพะทะฒัะฐัะฐะตั: { points: [...], currentPrice: ..., serverTime: ... }
```

---

## ะะตัะฐะปะธ ัะตะฐะปะธะทะฐัะธะธ

### PriceEngineManager

**ะัะฒะตัััะฒะตะฝะฝะพััั**:
- ะกะพะทะดะฐะฝะธะต engines ะดะปั ะบะฐะถะดะพะณะพ ะธะฝััััะผะตะฝัะฐ
- ะฃะฟัะฐะฒะปะตะฝะธะต ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ (start/stop)
- ะัะตะดะพััะฐะฒะปะตะฝะธะต eventBus ะดะปั WebSocket

**ะะฝะธัะธะฐะปะธะทะฐัะธั**:
```typescript
const manager = new PriceEngineManager();
manager.start(); // ะะฐะฟััะบะฐะตั engines ะดะปั ะฒัะตั ะธะฝััััะผะตะฝัะพะฒ ะธะท INSTRUMENTS
```

**ะะพัััะฟ ะบ eventBus**:
```typescript
const eventBus = manager.getEventBus('EURUSD');
// ะัะฟะพะปัะทัะตััั ะดะปั ะฟะพะดะฟะธัะบะธ WebSocket ะฝะฐ ัะพะฑััะธั
```

### PriceEventBus

**ะัะฒะตัััะฒะตะฝะฝะพััั**:
- Event-driven ะบะพะผะผัะฝะธะบะฐัะธั ะผะตะถะดั ะบะพะผะฟะพะฝะตะฝัะฐะผะธ
- ะะพะดะฟะธัะบะฐ/ะพัะฟะธัะบะฐ ะฝะฐ ัะพะฑััะธั
- ะญะผะธััะธั ัะพะฑััะธะน

**ะขะธะฟั ัะพะฑััะธะน**:
- `price_tick` โ ะฝะพะฒัะน ัะธะบ ัะตะฝั
- `candle_opened` โ ะพัะบัััะฐ ะฝะพะฒะฐั ัะฒะตัะฐ
- `candle_updated` โ ะพะฑะฝะพะฒะปะตะฝะฐ ะถะธะฒะฐั ัะฒะตัะฐ
- `candle_closed` โ ะทะฐะบัััะฐ ัะฒะตัะฐ

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต**:
```typescript
// ะะพะดะฟะธัะบะฐ
const unsubscribe = eventBus.on('price_tick', (event) => {
  console.log('New tick:', event.data);
});

// ะัะฟะธัะบะฐ
unsubscribe();
```

### CandleEngine

**ะัะฒะตัััะฒะตะฝะฝะพััั**:
- ะะณัะตะณะฐัะธั ัะธะบะพะฒ ะฒ 5-ัะตะบัะฝะดะฝัะต ัะฒะตัะธ
- ะััะปะตะถะธะฒะฐะฝะธะต high/low/open/close
- ะะฐะบัััะธะต ัะฒะตัะตะน ะฟะพ ะฒัะตะผะตะฝะธ

**ะะปะณะพัะธัะผ**:
1. ะััะธัะปัะตั ัะปะพั ะฒัะตะผะตะฝะธ: `Math.floor(timestamp / 5000) * 5000`
2. ะัะปะธ ะฝะพะฒัะน ัะปะพั โ ะพัะบััะฒะฐะตั ัะฒะตัั
3. ะะฑะฝะพะฒะปัะตั high/low/close ะฟัะธ ะบะฐะถะดะพะผ ัะธะบะต
4. ะัะธ ะฟะตัะตัะพะดะต ะฒ ะฝะพะฒัะน ัะปะพั โ ะทะฐะบััะฒะฐะตั ััะฐััั ัะฒะตัั

### TimeframeAggregator

**ะัะฒะตัััะฒะตะฝะฝะพััั**:
- ะะณัะตะณะฐัะธั 5s ัะฒะตัะตะน ะฒ ะดััะณะธะต ัะฐะนะผััะตะนะผั
- ะะพะดะดะตัะถะบะฐ: 10s, 15s, 30s, 1m, 2m, 3m, 5m, 10m, 15m, 30m, 1h, 4h, 1d

**ะะปะณะพัะธัะผ**:
- ะะพะดะฟะธััะฒะฐะตััั ะฝะฐ `candle_closed` (5s)
- ะะปั ะบะฐะถะดะพะณะพ ัะฐะนะผััะตะนะผะฐ ะฟัะพะฒะตััะตั, ะฝัะถะฝะพ ะปะธ ัะพะทะดะฐัั ะฝะพะฒัั ัะฒะตัั
- ะะณัะตะณะธััะตั ะฝะตัะบะพะปัะบะพ 5s ัะฒะตัะตะน ะฒ ะพะดะฝั ัะฒะตัั ะฑะพะปััะตะณะพ ัะฐะนะผััะตะนะผะฐ

---

## ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต

**ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั**:
- ะัะต ะธะฝััััะผะตะฝัั ัะฐะฑะพัะฐัั ะพะดะฝะพะฒัะตะผะตะฝะฝะพ
- ะะฐะถะดัะน ะธะฝััััะผะตะฝั ะณะตะฝะตัะธััะตั ~2 ัะธะบะฐ/ัะตะบ
- ะัะตะณะพ: 21 ะธะฝััััะผะตะฝั ร 2 ัะธะบะฐ/ัะตะบ = **42 ัะธะบะฐ/ัะตะบ**

**ะะฐะณััะทะบะฐ ะฝะฐ ะะ**:
- Price points: 21 ะธะฝััััะผะตะฝั ร 1 ัะพัะบะฐ/ัะตะบ = **21 ะทะฐะฟะธัั/ัะตะบ**
- ะกะฒะตัะธ: 21 ะธะฝััััะผะตะฝั ร 1 ัะฒะตัะฐ/5ัะตะบ = **4.2 ัะฒะตัะธ/ัะตะบ**

**WebSocket**:
- ะกะพะฑััะธั ะพัะฟัะฐะฒะปััััั ัะพะปัะบะพ ะฟะพะดะฟะธัะฐะฝะฝัะผ ะบะปะธะตะฝัะฐะผ
- ะัะปะธ ะบะปะธะตะฝั ะฟะพะดะฟะธัะฐะฝ ะฝะฐ 1 ะธะฝััััะผะตะฝั โ ะฟะพะปััะฐะตั ~2 ัะพะฑััะธั/ัะตะบ

### ะะฟัะธะผะธะทะฐัะธะธ

1. **Redis ะดะปั ัะตะบััะธั ัะตะฝ**: ะัััััะน ะดะพัััะฟ ะฑะตะท ะะ
2. **Event-driven**: ะะพะผะฟะพะฝะตะฝัั ะฝะต ะฑะปะพะบะธัััั ะดััะณ ะดััะณะฐ
3. **ะคะธะปัััะฐัะธั WebSocket**: ะัะฟัะฐะฒะบะฐ ัะพะปัะบะพ ะฟะพะดะฟะธัะฐะฝะฝัะผ ะบะปะธะตะฝัะฐะผ
4. **ะะฝะดะตะบัั ะะ**: ะัััััะน ะฟะพะธัะบ ะฟะพ symbol + timestamp

---

## ะะฐัััะพะนะบะฐ ะฟะฐัะฐะผะตััะพะฒ

### ะะทะผะตะฝะตะฝะธะต ะฒะพะปะฐัะธะปัะฝะพััะธ

**ะคะฐะนะป**: `backend/src/config/instruments.ts`

```typescript
EURUSD: forex('EURUSD', 'EUR', 'USD', 5, 1.08, 0.95, 1.25),
// ะะทะผะตะฝะธัั ะฒะพะปะฐัะธะปัะฝะพััั:
engine: {
  volatility: 0.0005, // ะฃะฒะตะปะธัะธัั ะฒะพะปะฐัะธะปัะฝะพััั (ะฑัะปะพ 0.0002)
  // ...
}
```

### ะะทะผะตะฝะตะฝะธะต ัะฐััะพัั ัะธะบะพะฒ

```typescript
engine: {
  tickInterval: 250, // 4 ัะธะบะฐ/ัะตะบ (ะฑัะปะพ 500 = 2 ัะธะบะฐ/ัะตะบ)
  // ...
}
```

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒะพะณะพ ะธะฝััััะผะตะฝัะฐ

```typescript
export const INSTRUMENTS: Record<string, InstrumentConfig> = {
  // ... ัััะตััะฒัััะธะต ะธะฝััััะผะตะฝัั
  
  NEWPAIR: forex('NEWPAIR', 'NEW', 'USD', 5, 1.0, 0.8, 1.2),
};
```

ะะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั:
1. ะะตัะตะทะฐะฟัััะธัั backend
2. `PriceEngineManager` ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐัั engine ะดะปั ะฝะพะฒะพะณะพ ะธะฝััััะผะตะฝัะฐ
3. WebSocket ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐัะฝะตั ะพัะฟัะฐะฒะปััั ัะพะฑััะธั

---

## ะะพะณะธัะพะฒะฐะฝะธะต

### ะะธะฐะณะฝะพััะธะบะฐ

**ะะปั AUDCHF ะฒะบะปััะตะฝะพ ะฟะพะดัะพะฑะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต**:

```typescript
// ะ OtcPriceEngine.ts
if (this.instrumentId === 'AUDCHF') {
  logger.info(`๐ฐ [AUDCHF] PriceEngine emitted price_tick: ${tick.price.toFixed(5)}`);
}

// ะ websocket.bootstrap.ts
if (instrumentId === 'AUDCHF') {
  logger.info(`๐ [AUDCHF] Price tick: ${tick.price.toFixed(5)}`);
}
```

**ะะปั ะดััะณะธั ะธะฝััััะผะตะฝัะพะฒ**: ะะพะณะธัะพะฒะฐะฝะธะต ัะพะปัะบะพ ะพัะธะฑะพะบ

---

## ะะตะทัะผะต

### ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ

1. **ะะพะปะฝะพัััั ัะฐะผะพะดะพััะฐัะพัะฝะฐั ัะธััะตะผะฐ**: ะะต ะทะฐะฒะธัะธั ะพั ะฒะฝะตัะฝะธั API
2. **ะะตะฐะปะธััะธัะฝะพะต ะฟะพะฒะตะดะตะฝะธะต**: Controlled random walk ะธะผะธัะธััะตั ััะฝะพะบ
3. **ะะฐัััะฐะฑะธััะตะผะพััั**: ะะตะณะบะพ ะดะพะฑะฐะฒะธัั ะฝะพะฒัะต ะธะฝััััะผะตะฝัั
4. **Event-driven**: ะะธะฑะบะฐั ะฐััะธัะตะบัััะฐ ะดะปั ัะฐััะธัะตะฝะธั
5. **Multi-instrument**: ะัะต ะธะฝััััะผะตะฝัั ัะฐะฑะพัะฐัั ะฟะฐัะฐะปะปะตะปัะฝะพ

### ะะดะต ะธัะฟะพะปัะทััััั ะบะพัะธัะพะฒะบะธ

1. **ะกะฒะตัะฝะพะน ะณัะฐัะธะบ**: ะกะฒะตัะธ ะธะท `candles` ัะฐะฑะปะธัั
2. **ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ**: Price points ะธะท `price_points` ัะฐะฑะปะธัั
3. **ะะฝะดะธะบะฐัะพัั**: ะััะธัะปััััั ะฝะฐ ะพัะฝะพะฒะต ัะฒะตัะตะน
4. **ะขะพัะณะพะฒะปั**: ะขะตะบััะฐั ัะตะฝะฐ ะธะท Redis ะดะปั ะพัะบัััะธั ัะดะตะปะพะบ
5. **WebSocket**: Real-time ะพะฑะฝะพะฒะปะตะฝะธั ะดะปั ะบะปะธะตะฝัะพะฒ

### ะคะฐะนะปั ัะธััะตะผั

**Backend**:
- `backend/src/prices/engines/OtcPriceEngine.ts` โ ะณะตะฝะตัะฐัะธั ัะตะฝ
- `backend/src/prices/PriceEngineManager.ts` โ ะพัะบะตัััะฐัะพั
- `backend/src/config/instruments.ts` โ ะบะพะฝัะธะณััะฐัะธั ะธะฝััััะผะตะฝัะพะฒ
- `backend/src/prices/store/PriceStore.ts` โ Redis ััะฐะฝะธะปะธัะต
- `backend/src/prices/store/CandleStore.ts` โ PostgreSQL ััะฐะฝะธะปะธัะต ัะฒะตัะตะน
- `backend/src/prices/PricePointWriter.ts` โ ะทะฐะฟะธัั price points
- `backend/src/bootstrap/websocket.bootstrap.ts` โ WebSocket ะธะฝัะตะณัะฐัะธั

**Frontend**:
- `frontend/lib/hooks/useWebSocket.ts` โ WebSocket ะบะปะธะตะฝั
- `frontend/components/chart/useChart.ts` โ ัะฒะตัะฝะพะน ะณัะฐัะธะบ
- `frontend/components/chart/line/useLineChart.ts` โ ะปะธะฝะตะนะฝัะน ะณัะฐัะธะบ

---

**ะะฐัะฐ ัะพะทะดะฐะฝะธั**: 2026-01-29  
**ะะตััะธั**: 1.0
