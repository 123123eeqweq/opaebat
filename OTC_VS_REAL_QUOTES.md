# OTC vs Real Quotes: ะััะธัะตะบัััะฐ ะธ ะพัะปะธัะธั

## ๐ ะกะพะดะตัะถะฐะฝะธะต

1. [ะะฑะทะพั](#ะพะฑะทะพั)
2. [OTC ะบะพัะธัะพะฒะบะธ (Over The Counter)](#otc-ะบะพัะธัะพะฒะบะธ-over-the-counter)
3. [ะะตะฐะปัะฝัะต ะบะพัะธัะพะฒะบะธ (Real Market Quotes)](#ัะตะฐะปัะฝัะต-ะบะพัะธัะพะฒะบะธ-real-market-quotes)
4. [ะะปััะตะฒัะต ะพัะปะธัะธั](#ะบะปััะตะฒัะต-ะพัะปะธัะธั)
5. [ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ: OTC vs Real](#ะปะธะฝะตะนะฝัะน-ะณัะฐัะธะบ-otc-vs-real)
6. [ะัะพะฑะปะตะผั ะธ ะพะณัะฐะฝะธัะตะฝะธั](#ะฟัะพะฑะปะตะผั-ะธ-ะพะณัะฐะฝะธัะตะฝะธั)
7. [ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ัะปัััะตะฝะธั](#ัะตะบะพะผะตะฝะดะฐัะธะธ-ะฟะพ-ัะปัััะตะฝะธั)

---

## ะะฑะทะพั

ะ ัะธััะตะผะต ะฟะพะดะดะตัะถะธะฒะฐัััั ะดะฒะฐ ัะธะฟะฐ ะธััะพัะฝะธะบะพะฒ ะบะพัะธัะพะฒะพะบ:

- **OTC (Over The Counter)** โ ะบะพัะธัะพะฒะบะธ, ะณะตะฝะตัะธััะตะผัะต ะฒะฝัััะธ ัะธััะตะผั
- **Real (Real Market Quotes)** โ ะบะพัะธัะพะฒะบะธ ะธะท ะฒะฝะตัะฝะธั ะธััะพัะฝะธะบะพะฒ (xchangeapi.com)

ะะฑะฐ ัะธะฟะฐ ะธะฝัะตะณัะธัะพะฒะฐะฝั ะฒ ะตะดะธะฝัั ะฐััะธัะตะบัััั ัะตัะตะท `PriceEngineManager` ะธ ะธัะฟะพะปัะทััั ะพะดะธะฝะฐะบะพะฒัะน event-driven pipeline.

---

## OTC ะบะพัะธัะพะฒะบะธ (Over The Counter)

### ะงัะพ ัะฐะบะพะต OTC?

**OTC ะบะพัะธัะพะฒะบะธ** โ ััะพ ะธัะบััััะฒะตะฝะฝะพ ะณะตะฝะตัะธััะตะผัะต ัะตะฝั, ะบะพัะพััะต ัะพะทะดะฐัััั ะฐะปะณะพัะธัะผะพะผ ะฒะฝัััะธ ัะธััะตะผั. ะะฝะธ ะฝะต ะทะฐะฒะธััั ะพั ะฒะฝะตัะฝะธั ะธััะพัะฝะธะบะพะฒ ะธ ะฟะพะปะฝะพัััั ะบะพะฝััะพะปะธัััััั ัะธััะตะผะพะน.

### ะััะธัะตะบัััะฐ OTC

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      OtcPriceEngine                     โ
โ  (ะะตะฝะตัะฐัะธั ัะตะฝ ะฟะพ ะฐะปะณะพัะธัะผั)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      PriceEventBus                      โ
โ  (price_tick ัะพะฑััะธั)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโผโโโโโโโโโโ
    โ         โ         โ
โโโโโโโโโโ โโโโโโโโ โโโโโโโโโโโโโโโโ
โCandles โ โRedis โ โPricePoints   โ
โ(5s TF) โ โStore โ โ(1 point/sec) โ
โโโโโโโโโโ โโโโโโโโ โโโโโโโโโโโโโโโโ
```

### ะะฐะบ ัะฐะฑะพัะฐะตั ะณะตะฝะตัะฐัะธั ัะตะฝ

**ะคะฐะนะป**: `backend/src/prices/engines/OtcPriceEngine.ts`

#### ะะปะณะพัะธัะผ: Controlled Random Walk

```typescript
// 1. ะะตะฝะตัะธััะตะผ ัะปััะฐะนะฝะพะต ะธะทะผะตะฝะตะฝะธะต ะฒ ะฟัะตะดะตะปะฐั ะฒะพะปะฐัะธะปัะฝะพััะธ
const changePercent = (Math.random() - 0.5) * 2 * volatility;
// ะะธะฐะฟะฐะทะพะฝ: [-volatility, +volatility]

// 2. ะััะธัะปัะตะผ ะธะทะผะตะฝะตะฝะธะต ัะตะฝั
const change = currentPrice * changePercent;

// 3. ะัะธะผะตะฝัะตะผ ะธะทะผะตะฝะตะฝะธะต
let newPrice = currentPrice + change;

// 4. ะะณัะฐะฝะธัะธะฒะฐะตะผ ะณัะฐะฝะธัะฐะผะธ (minPrice, maxPrice)
newPrice = Math.max(minPrice, Math.min(maxPrice, newPrice));
```

#### ะะพะฝัะธะณััะฐัะธั ะธะฝััััะผะตะฝัะฐ

**ะคะฐะนะป**: `backend/src/config/instruments.ts`

```typescript
EURUSD: {
  id: 'EURUSD',
  base: 'EUR',
  quote: 'USD',
  digits: 5,
  source: 'otc',
  engine: {
    asset: 'EUR/USD',
    initialPrice: 1.08,
    minPrice: 0.95,
    maxPrice: 1.25,
    volatility: 0.0002,  // 0.02% ะฒะพะปะฐัะธะปัะฝะพััั
    tickInterval: 500,   // ะะฑะฝะพะฒะปะตะฝะธะต ะบะฐะถะดัะต 500ms
  },
}
```

### ะัะพะฑะตะฝะฝะพััะธ OTC

1. **ะะตัะตัะผะธะฝะธัะพะฒะฐะฝะฝะพััั**: ะฆะตะฝั ะณะตะฝะตัะธัััััั ะฟะพ ะฐะปะณะพัะธัะผั, ะผะพะถะฝะพ ะฒะพัะฟัะพะธะทะฒะตััะธ
2. **ะะพะฝััะพะปั**: ะะพะปะฝัะน ะบะพะฝััะพะปั ะฝะฐะด ะฒะพะปะฐัะธะปัะฝะพัััั ะธ ะณัะฐะฝะธัะฐะผะธ ัะตะฝ
3. **ะกัะฐะฑะธะปัะฝะพััั**: ะะต ะทะฐะฒะธัะธั ะพั ะฒะฝะตัะฝะธั API, ะฒัะตะณะดะฐ ะดะพัััะฟะฝั
4. **ะัะตะผั**: ะัะฟะพะปัะทัะตั server-time, ัะฒะตัะธ ะทะฐะบััะฒะฐัััั ัะธะฝััะพะฝะฝะพ (:00, :05, :10...)
5. **ะััะพัะธั**: ะะฐะฝะฝัะต ะทะฐะฟะธััะฒะฐัััั ะฒ ะะ ั ะผะพะผะตะฝัะฐ ะทะฐะฟััะบะฐ ัะธััะตะผั

### ะะพัะพะบ ะดะฐะฝะฝัั OTC

1. **ะะตะฝะตัะฐัะธั**: `OtcPriceEngine` ะณะตะฝะตัะธััะตั ัะตะฝั ะบะฐะถะดัะต 500ms
2. **ะกะพะฑััะธะต**: ะญะผะธัะธั `price_tick` ะฒ `PriceEventBus`
3. **ะะฑัะฐะฑะพัะบะฐ**:
   - `CandleEngine` โ ะฐะณัะตะณะธััะตั ะฒ 5-ัะตะบัะฝะดะฝัะต ัะฒะตัะธ
   - `PricePointWriter` โ ะทะฐะฟะธััะฒะฐะตั 1 ัะพัะบั ะฒ ัะตะบัะฝะดั ะฒ ะะ
   - `PriceStore` โ ะพะฑะฝะพะฒะปัะตั ัะตะบัััั ัะตะฝั ะฒ Redis
4. **WebSocket**: ะกะพะฑััะธั ะดะพััะฐะฒะปััััั ะบะปะธะตะฝัะฐะผ ัะตัะตะท WebSocket

---

## ะะตะฐะปัะฝัะต ะบะพัะธัะพะฒะบะธ (Real Market Quotes)

### ะงัะพ ัะฐะบะพะต Real ะบะพัะธัะพะฒะบะธ?

**Real ะบะพัะธัะพะฒะบะธ** โ ััะพ ัะตะฐะปัะฝัะต ััะฝะพัะฝัะต ัะตะฝั, ะฟะพะปััะฐะตะผัะต ะธะท ะฒะฝะตัะฝะธั ะธััะพัะฝะธะบะพะฒ (xchangeapi.com). ะะฝะธ ะพััะฐะถะฐัั ัะตะฐะปัะฝัั ัะพัะณะพะฒะปั ะฝะฐ ััะฝะบะต.

### ะััะธัะตะบัััะฐ Real

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      RealPriceEngine                    โ
โ  (WebSocket โ xchangeapi.com)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      PriceEventBus                      โ
โ  (price_tick ัะพะฑััะธั)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโผโโโโโโโโโโ
    โ         โ         โ
โโโโโโโโโโ โโโโโโโโ โโโโโโโโโโโโโโโโ
โCandles โ โRedis โ โPricePoints   โ
โ(5s TF) โ โStore โ โ(1 point/sec) โ
โโโโโโโโโโ โโโโโโโโ โโโโโโโโโโโโโโโโ
```

### ะะฐะบ ัะฐะฑะพัะฐะตั RealPriceEngine

**ะคะฐะนะป**: `backend/src/prices/engines/RealPriceEngine.ts`

#### WebSocket ะฟะพะดะบะปััะตะฝะธะต

```typescript
// ะะพะดะบะปััะตะฝะธะต ะบ xchangeapi.com
this.ws = new WebSocket('wss://api.xchangeapi.com/websocket/live', {
  headers: {
    'api-key': this.config.apiKey,
  },
});

// ะะพะดะฟะธัะบะฐ ะฝะฐ ะฟะฐัั
ws.send(JSON.stringify({ pairs: ['EURUSD'] }));
```

#### ะัะพัะพะบะพะป xchangeapi.com

**ะคะพัะผะฐั ัะพะพะฑัะตะฝะธะน**:

1. **INIT (code 0)**: ะะตัะฐะดะฐะฝะฝัะต ัะตััะธะธ
   ```
   0{"session_uid":"...","time_mult":1000,"start_time":1769765839.563,"order":["name","time","ask","bid"],"mapping":{"0":"EURUSD"}}
   ```

2. **UPDATE (code 1)**: ะะฑะฝะพะฒะปะตะฝะธะต ัะตะฝั
   ```
   10|1.19194|1.19183|5518
   ```
   ะคะพัะผะฐั: `name|ask|bid|relativeTime`

#### ะะพัะผะฐะปะธะทะฐัะธั ะฒัะตะผะตะฝะธ

**ะัะธัะธัะตัะบะธ ะฒะฐะถะฝะพ**: Real ะบะพัะธัะพะฒะบะธ ะธัะฟะพะปัะทััั **market-time** (ะฒัะตะผั ะฑะธัะถะธ), ะฐ ัะธััะตะผะฐ ะพะถะธะดะฐะตั **server-time**.

**ะะตัะตะฝะธะต**: ะะพัะผะฐะปะธะทะฐัะธั ะฒัะตะผะตะฝะธ ัะตัะตะท offset

```typescript
// ะัะธ ะฟะพะปััะตะฝะธะธ INIT ะฒััะธัะปัะตะผ offset
const marketTimeMs = Math.floor(meta.start_time * 1000);
const serverTimeMs = Date.now();
this.timeOffsetMs = serverTimeMs - marketTimeMs;

// ะัะธ ะพะฑัะฐะฑะพัะบะต ะบะฐะถะดะพะณะพ ัะธะบะฐ ะฟัะธะผะตะฝัะตะผ offset
const marketTimeMs = Math.floor(timestampSeconds * 1000);
const timestampMs = marketTimeMs + this.timeOffsetMs; // ะะพัะผะฐะปะธะทะฐัะธั ะบ server-time
```

**ะะฐัะตะผ ััะพ ะฝัะถะฝะพ**: ะงัะพะฑั ัะฒะตัะธ ะทะฐะบััะฒะฐะปะธัั ัะธะฝััะพะฝะฝะพ ั ัะตัะบะพะน (:00, :05, :10...), ะบะฐะบ ั OTC.

#### ะะพะฝัะธะณััะฐัะธั ะธะฝััััะผะตะฝัะฐ

```typescript
EURUSD_REAL: {
  id: 'EURUSD_REAL',
  base: 'EUR',
  quote: 'USD',
  digits: 5,
  source: 'real',
  real: {
    provider: 'xchange',
    pair: 'EURUSD',  // ะะฐัะฐ ะดะปั xchangeapi.com
  },
}
```

### ะัะพะฑะตะฝะฝะพััะธ Real

1. **ะะตะฐะปัะฝะพััั**: ะฆะตะฝั ะพััะฐะถะฐัั ัะตะฐะปัะฝัะน ััะฝะพะบ
2. **ะะฐะฒะธัะธะผะพััั**: ะะฐะฒะธัะธั ะพั ะฒะฝะตัะฝะตะณะพ API (xchangeapi.com)
3. **ะะพะปะฐัะธะปัะฝะพััั**: ะะตะฐะปัะฝะฐั ััะฝะพัะฝะฐั ะฒะพะปะฐัะธะปัะฝะพััั
4. **ะัะตะผั**: Market-time ะฝะพัะผะฐะปะธะทัะตััั ะบ server-time ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ
5. **ะััะพัะธั**: ะะฐะฝะฝัะต ะทะฐะฟะธััะฒะฐัััั ัะพะปัะบะพ ั ะผะพะผะตะฝัะฐ ะฟะพะดะบะปััะตะฝะธั

---

## ะะปััะตะฒัะต ะพัะปะธัะธั

| ะะฐัะฐะผะตัั | OTC | Real |
|----------|-----|------|
| **ะััะพัะฝะธะบ ะดะฐะฝะฝัั** | ะะปะณะพัะธัะผ ะณะตะฝะตัะฐัะธะธ | ะะฝะตัะฝะธะน API (xchangeapi.com) |
| **ะะพะปะฐัะธะปัะฝะพััั** | ะะพะฝััะพะปะธััะตะผะฐั (0.02%) | ะะตะฐะปัะฝะฐั ััะฝะพัะฝะฐั |
| **ะัะตะผั** | Server-time (ะดะตัะตัะผะธะฝะธัะพะฒะฐะฝะฝะพะต) | Market-time (ะฝะพัะผะฐะปะธะทัะตััั ะบ server-time) |
| **ะะพัััะฟะฝะพััั** | ะัะตะณะดะฐ ะดะพัััะฟะฝั | ะะฐะฒะธัะธั ะพั ะฒะฝะตัะฝะตะณะพ API |
| **ะััะพัะธั** | ะก ะผะพะผะตะฝัะฐ ะทะฐะฟััะบะฐ ัะธััะตะผั | ะขะพะปัะบะพ ั ะผะพะผะตะฝัะฐ ะฟะพะดะบะปััะตะฝะธั |
| **ะกัะพะธะผะพััั** | ะะตัะฟะปะฐัะฝะพ | ะขัะตะฑัะตั API key |
| **ะกัะฐะฑะธะปัะฝะพััั** | ะััะพะบะฐั | ะกัะตะดะฝัั (ะทะฐะฒะธัะธั ะพั API) |
| **ะะพะฝััะพะปั** | ะะพะปะฝัะน ะบะพะฝััะพะปั | ะะณัะฐะฝะธัะตะฝะฝัะน ะบะพะฝััะพะปั |

### ะััะธัะตะบัััะฝัะต ะพัะปะธัะธั

#### OTC Engine

```typescript
class OtcPriceEngine {
  // ะะตะฝะตัะธััะตั ัะตะฝั ะฟะพ ัะฐะนะผะตัั
  private interval: NodeJS.Timeout;
  
  generatePrice(): number {
    // ะะปะณะพัะธัะผ Controlled Random Walk
  }
}
```

#### Real Engine

```typescript
class RealPriceEngine {
  // ะะพะดะบะปััะฐะตััั ะบ WebSocket
  private ws: WebSocket;
  
  // ะะฑัะฐะฑะฐััะฒะฐะตั ัะพะพะฑัะตะฝะธั ะพั API
  handleMessage(data: string): void {
    // ะะฐััะธะฝะณ ะฟัะพัะพะบะพะปะฐ xchangeapi.com
  }
}
```

### ะะฑัะตะต ะฒ ะฐััะธัะตะบัััะต

ะะฑะฐ ัะธะฟะฐ ะธัะฟะพะปัะทััั:
- โ ะะดะธะฝ ะธ ัะพั ะถะต `PriceEventBus` ะดะปั ัะพะฑััะธะน
- โ ะะดะธะฝ ะธ ัะพั ะถะต `CandleEngine` ะดะปั ะฐะณัะตะณะฐัะธะธ ัะฒะตัะตะน
- โ ะะดะธะฝ ะธ ัะพั ะถะต `PricePointWriter` ะดะปั ะทะฐะฟะธัะธ ัะพัะตะบ
- โ ะะดะธะฝ ะธ ัะพั ะถะต WebSocket bootstrap ะดะปั ะดะพััะฐะฒะบะธ ะบะปะธะตะฝัะฐะผ
- โ ะะดะธะฝ ะธ ัะพั ะถะต `PriceStore` (Redis) ะดะปั ัะตะบััะธั ัะตะฝ

---

## ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ: OTC vs Real

### ะะฐะบ ัะฐะฑะพัะฐะตั ะปะธะฝะตะนะฝัะน ะณัะฐัะธะบ

**ะะพะฝัะตะฟัะธั**: ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ ัััะพะธััั ะฝะฐ ะพัะฝะพะฒะต **price points** (ัะพัะตะบ ัะตะฝั) โ ะฟะพ 1 ัะพัะบะต ะฒ ัะตะบัะฝะดั.

**ะคะฐะนะป**: `frontend/components/chart/line/LineChart.tsx`

### ะััะธัะตะบัััะฐ ะปะธะฝะตะนะฝะพะณะพ ะณัะฐัะธะบะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      LineChart Component                โ
โ  (React ะบะพะผะฟะพะฝะตะฝั)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      useLineChart Hook                  โ
โ  (ะัะบะตัััะฐัะพั ะปะพะณะธะบะธ)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโผโโโโโโโโโโ
    โ         โ         โ
โโโโโโโโโโ โโโโโโโโโโ โโโโโโโโโโโโโโโโ
โStore   โ โViewportโ โWebSocket     โ
โ(Points)โ โ(Time)  โ โ(Live updates)โ
โโโโโโโโโโ โโโโโโโโโโ โโโโโโโโโโโโโโโโ
```

### ะะฝะธัะธะฐะปะธะทะฐัะธั ะณัะฐัะธะบะฐ

#### 1. ะะฐะณััะทะบะฐ Snapshot

**API**: `GET /api/line/snapshot?symbol=EURUSD`

**Backend**: `backend/src/modules/linechart/linechart.controller.ts`

```typescript
// ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะต 600 ัะพัะตะบ (~10 ะผะธะฝัั)
const pricePoints = await prisma.pricePoint.findMany({
  where: { symbol },
  orderBy: { timestamp: 'desc' },
  take: 600,
});
```

**Frontend**: `frontend/components/chart/line/LineChart.tsx`

```typescript
const snapshot = await api(`/api/line/snapshot?symbol=${instrument}`);
lineChart.initializeFromSnapshot(snapshot);
```

#### 2. Infinite Scroll (ะฟะพะดะณััะทะบะฐ ะธััะพัะธะธ)

**API**: `GET /api/line/history?symbol=EURUSD&to=TIMESTAMP&limit=300`

**Backend**:

```typescript
// ะะพะปััะฐะตะผ ัะพัะบะธ ะดะพ ัะบะฐะทะฐะฝะฝะพะณะพ ะฒัะตะผะตะฝะธ
const pricePoints = await prisma.pricePoint.findMany({
  where: {
    symbol,
    timestamp: { lt: BigInt(toTime) },
  },
  orderBy: { timestamp: 'desc' },
  take: limit,
});
```

**Frontend**:

```typescript
// ะัะธ ะฟัะพะบัััะบะต ะฒะปะตะฒะพ ะทะฐะณััะถะฐะตะผ ะธััะพัะธั
if (viewport.timeStart - firstPoint.time < threshold) {
  const { points } = await api(
    `/api/line/history?symbol=${instrument}&to=${firstPoint.time}&limit=300`
  );
  lineChart.prependHistory(points);
}
```

### Live ะพะฑะฝะพะฒะปะตะฝะธั

**WebSocket ัะพะฑััะธะต**: `price:update`

```typescript
{
  type: 'price:update',
  instrument: 'EURUSD',
  data: {
    asset: 'EUR/USD',
    price: 1.19016,
    timestamp: 1769731845000,
  },
}
```

**ะะฑัะฐะฑะพัะบะฐ ะฝะฐ ััะพะฝัะตะฝะดะต**:

```typescript
// useLineData.ts
onPriceUpdate(price: number, timestamp: number) {
  // 1. ะกะพะทะดะฐะตะผ ephemeral LiveSegment (ะฐะฝะธะผะธัะพะฒะฐะฝะฝะฐั ะปะธะฝะธั)
  const liveSegment = {
    fromTime: lastHistoryPoint.time,
    toTime: timestamp,
    fromPrice: lastHistoryPoint.price,
    animatedPrice: price,
  };
  
  // 2. ะะฐะท ะฒ ัะตะบัะฝะดั ะฟััะธะผ ัะธะบัะธัะพะฒะฐะฝะฝัั ัะพัะบั ะฒ store
  const second = Math.floor(timestamp / 1000) * 1000;
  if (lastSecond !== second) {
    pointStore.push({ time: second, price });
    setLiveSegment(null); // ะัะธัะฐะตะผ live segment
  }
}
```

---

## ะัะพะฑะปะตะผั ะธ ะพะณัะฐะฝะธัะตะฝะธั

### ะัะพะฑะปะตะผะฐ 1: ะััะพัะธั ะดะปั Real ะบะพัะธัะพะฒะพะบ

#### ะขะตะบััะฐั ัะธััะฐัะธั

**OTC**:
- โ ะััะพัะธั ะทะฐะฟะธััะฒะฐะตััั ะฒ ะะ ั ะผะพะผะตะฝัะฐ ะทะฐะฟััะบะฐ ัะธััะตะผั
- โ ะัะธ ะพัะบัััะธะธ ะณัะฐัะธะบะฐ ะทะฐะณััะถะฐะตััั snapshot (ะฟะพัะปะตะดะฝะธะต 600 ัะพัะตะบ)
- โ Infinite scroll ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ

**Real**:
- โ๏ธ ะััะพัะธั ะทะฐะฟะธััะฒะฐะตััั ัะพะปัะบะพ ั ะผะพะผะตะฝัะฐ ะฟะพะดะบะปััะตะฝะธั ะบ API
- โ๏ธ ะัะธ ะฟะตัะฒะพะผ ะพัะบัััะธะธ ะณัะฐัะธะบะฐ ะผะพะถะตั ะฑััั ะฟัััะพะน snapshot
- โ๏ธ Infinite scroll ะฝะต ัะฐะฑะพัะฐะตั, ะตัะปะธ ะฝะตั ะธััะพัะธะธ ะฒ ะะ

#### ะะพัะตะผั ััะพ ะฟัะพะธััะพะดะธั?

1. **RealPriceEngine** ะฝะฐัะธะฝะฐะตั ะทะฐะฟะธััะฒะฐัั ะดะฐะฝะฝัะต ัะพะปัะบะพ ะฟะพัะปะต ะฟะพะดะบะปััะตะฝะธั ะบ WebSocket
2. ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะพัะบััะป ะณัะฐัะธะบ ัะตัะตะท 5 ะผะธะฝัั ะฟะพัะปะต ะทะฐะฟััะบะฐ ัะธััะตะผั, ั ะฝะตะณะพ ะฑัะดะตั ัะพะปัะบะพ 5 ะผะธะฝัั ะธััะพัะธะธ
3. ะะตั ะผะตัะฐะฝะธะทะผะฐ ะทะฐะณััะทะบะธ ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั ะธะท ะฒะฝะตัะฝะตะณะพ API

### ะัะพะฑะปะตะผะฐ 2: Symbol mapping

#### ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั

**Backend**: `backend/src/modules/linechart/linechart.controller.ts`

```typescript
// ะะปั OTC
const symbol = config.engine.asset; // "EUR/USD"

// ะะปั Real
const symbol = config.real.pair; // "EURUSD" (ะฑะตะท ัะปะตัะฐ)
```

**ะัะพะฑะปะตะผะฐ**: 
- OTC ะธัะฟะพะปัะทัะตั ัะพัะผะฐั `"EUR/USD"` (ัะพ ัะปะตัะตะผ)
- Real ะธัะฟะพะปัะทัะตั ัะพัะผะฐั `"EURUSD"` (ะฑะตะท ัะปะตัะฐ)
- ะ ะะ `price_points` ััะฐะฝัััั ั ัะฐะทะฝัะผะธ ัะพัะผะฐัะฐะผะธ ัะธะผะฒะพะปะพะฒ

**ะะตัะตะฝะธะต**: ะัะถะฝะฐ ะฝะพัะผะฐะปะธะทะฐัะธั ัะธะผะฒะพะปะพะฒ ะฟัะธ ะทะฐะฟะธัะธ ะธ ััะตะฝะธะธ.

### ะัะพะฑะปะตะผะฐ 3: ะััััััะฒะธะต ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั ะธะท API

#### ะงัะพ ะฝะต ัะฒะฐัะฐะตั

1. **ะััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต**: xchangeapi.com ะฝะต ะฟัะตะดะพััะฐะฒะปัะตั ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต ัะตัะตะท WebSocket
2. **Backfill ะผะตัะฐะฝะธะทะผ**: ะะตั ะผะตัะฐะฝะธะทะผะฐ ะทะฐะณััะทะบะธ ะธััะพัะธะธ ะฟัะธ ะฟะตัะฒะพะผ ะฟะพะดะบะปััะตะฝะธะธ
3. **ะัะฐะฝะธัั ะดะฐะฝะฝัั**: ะะตะฟะพะฝััะฝะพ, ัะบะพะปัะบะพ ะธััะพัะธะธ ะดะพัััะฟะฝะพ ะดะปั Real ะธะฝััััะผะตะฝัะพะฒ

#### ะะพะทะผะพะถะฝัะต ัะตัะตะฝะธั

1. **ะัะฟะพะปัะทะพะฒะฐัั ะดััะณะพะน API** ะดะปั ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั
2. **ะะตัะธัะพะฒะฐัั ะดะฐะฝะฝัะต** ะฟัะธ ะฟะตัะฒะพะผ ะฟะพะดะบะปััะตะฝะธะธ
3. **ะะพะบะฐะทัะฒะฐัั ะฟัะตะดัะฟัะตะถะดะตะฝะธะต** ะฟะพะปัะทะพะฒะฐัะตะปั, ะตัะปะธ ะธััะพัะธะธ ะฝะตั

### ะัะพะฑะปะตะผะฐ 4: ะะพัะผะฐะปะธะทะฐัะธั ะฒัะตะผะตะฝะธ

#### ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั

```typescript
// RealPriceEngine.ts
// Offset ะฒััะธัะปัะตััั ะฟัะธ ะฟะตัะฒะพะผ ัะธะบะต
if (!this.offsetCalculated) {
  const serverTimeMs = Date.now();
  this.timeOffsetMs = serverTimeMs - marketTimeMs;
  this.offsetCalculated = true;
}
```

**ะัะพะฑะปะตะผะฐ**: 
- Offset ะฒััะธัะปัะตััั ะฝะฐ ะพัะฝะพะฒะต ะฟะตัะฒะพะณะพ ัะธะบะฐ
- ะัะปะธ ะฟะตัะฒัะน ัะธะบ ะฟัะธัะตะป ั ะทะฐะดะตัะถะบะพะน, offset ะผะพะถะตั ะฑััั ะฝะตัะพัะฝัะผ
- ะัะธ ะฟะตัะตะฟะพะดะบะปััะตะฝะธะธ offset ะฟะตัะตััะธััะฒะฐะตััั, ััะพ ะผะพะถะตั ะฒัะทะฒะฐัั ัะบะฐัะบะธ ะฒัะตะผะตะฝะธ

**ะะตัะตะฝะธะต**: ะัะฟะพะปัะทะพะฒะฐัั ะฑะพะปะตะต ัะพัะฝัะน ะผะตัะพะด ะฒััะธัะปะตะฝะธั offset (ะฝะฐะฟัะธะผะตั, ะฝะฐ ะพัะฝะพะฒะต INIT ัะพะพะฑัะตะฝะธั).

---

## ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ัะปัััะตะฝะธั

### 1. ะฃะฝะธัะธะบะฐัะธั ัะธะผะฒะพะปะพะฒ

**ะัะพะฑะปะตะผะฐ**: ะะฐะทะฝัะต ัะพัะผะฐัั ัะธะผะฒะพะปะพะฒ ะดะปั OTC ะธ Real.

**ะะตัะตะฝะธะต**: ะกะพะทะดะฐัั ััะฝะบัะธั ะฝะพัะผะฐะปะธะทะฐัะธะธ ัะธะผะฒะพะปะพะฒ:

```typescript
function normalizeSymbol(instrumentId: string, source: 'otc' | 'real'): string {
  const config = getInstrumentOrDefault(instrumentId);
  if (source === 'otc') {
    return config.engine?.asset ?? `${config.base}/${config.quote}`;
  } else {
    // ะะปั real ะฒัะตะณะดะฐ ะธัะฟะพะปัะทัะตะผ ัะพัะผะฐั "EUR/USD"
    return `${config.base}/${config.quote}`;
  }
}
```

### 2. ะััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต ะดะปั Real

**ะัะพะฑะปะตะผะฐ**: ะะตั ะธััะพัะธะธ ะฟัะธ ะฟะตัะฒะพะผ ะพัะบัััะธะธ Real ะธะฝััััะผะตะฝัะฐ.

**ะะตัะตะฝะธะต**: 

1. **Backfill ะฟัะธ ะฟะพะดะบะปััะตะฝะธะธ**:
   ```typescript
   // ะัะธ ะฟะพะดะบะปััะตะฝะธะธ RealPriceEngine ะทะฐะณััะถะฐัั ะฟะพัะปะตะดะฝะธะต N ัะพัะตะบ ะธะท API
   // (ะตัะปะธ API ะฟะพะดะดะตัะถะธะฒะฐะตั ะธััะพัะธัะตัะบะธะต ะทะฐะฟัะพัั)
   ```

2. **ะะพะบะฐะทัะฒะฐัั ะฟัะตะดัะฟัะตะถะดะตะฝะธะต**:
   ```typescript
   // ะัะปะธ snapshot ะฟัััะพะน, ะฟะพะบะฐะทัะฒะฐัั ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
   if (snapshot.points.length === 0) {
     showWarning('ะััะพัะธั ะฑัะดะตั ะดะพัััะฟะฝะฐ ะฟะพัะปะต ะฟะพะปััะตะฝะธั ะดะฐะฝะฝัั ะพั ะฟัะพะฒะฐะนะดะตัะฐ');
   }
   ```

3. **ะัะฟะพะปัะทะพะฒะฐัั ะดััะณะพะน ะธััะพัะฝะธะบ** ะดะปั ะธััะพัะธะธ:
   - Alpha Vantage API
   - Yahoo Finance API
   - ะััะณะธะต ะฑะตัะฟะปะฐัะฝัะต ะธััะพัะฝะธะบะธ ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั

### 3. ะฃะปัััะตะฝะธะต ะฝะพัะผะฐะปะธะทะฐัะธะธ ะฒัะตะผะตะฝะธ

**ะัะพะฑะปะตะผะฐ**: Offset ะผะพะถะตั ะฑััั ะฝะตัะพัะฝัะผ.

**ะะตัะตะฝะธะต**: ะัะฟะพะปัะทะพะฒะฐัั ะฑะพะปะตะต ัะพัะฝัะน ะผะตัะพะด:

```typescript
// ะัะธ ะฟะพะปััะตะฝะธะธ INIT ะฒััะธัะปัะตะผ offset ะฝะฐ ะพัะฝะพะฒะต start_time
const marketTimeMs = Math.floor(meta.start_time * 1000);
const serverTimeMs = Date.now();
this.timeOffsetMs = serverTimeMs - marketTimeMs;

// ะัะธ ะฟะตัะฒะพะผ ัะธะบะต ััะพัะฝัะตะผ offset
if (!this.offsetCalculated) {
  const serverTimeMs = Date.now();
  const refinedOffset = serverTimeMs - marketTimeMs;
  // ะัะฟะพะปัะทัะตะผ ััะตะดะฝะตะต ะทะฝะฐัะตะฝะธะต ะดะปั ะฑะพะปััะตะน ัะพัะฝะพััะธ
  this.timeOffsetMs = (this.timeOffsetMs + refinedOffset) / 2;
  this.offsetCalculated = true;
}
```

### 4. ะะฑัะฐะฑะพัะบะฐ ะฟัััะพะณะพ snapshot

**ะัะพะฑะปะตะผะฐ**: ะัะธ ะฟัััะพะผ snapshot ะณัะฐัะธะบ ะฝะต ะธะฝะธัะธะฐะปะธะทะธััะตััั ะบะพััะตะบัะฝะพ.

**ะะตัะตะฝะธะต**: 

```typescript
// Frontend: LineChart.tsx
if (snapshot.points.length === 0) {
  // ะะฝะธัะธะฐะปะธะทะธััะตะผ ะณัะฐัะธะบ ั ัะตะบััะตะน ัะตะฝะพะน
  lineChart.initializeFromSnapshot({
    points: [],
    currentPrice: snapshot.currentPrice,
    serverTime: snapshot.serverTime,
  });
  
  // ะะพะบะฐะทัะฒะฐะตะผ ะธะฝะดะธะบะฐัะพั ะทะฐะณััะทะบะธ ะธััะพัะธะธ
  showLoadingIndicator('ะะถะธะดะฐะฝะธะต ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั...');
}
```

### 5. ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธัะพะฒะฐะฝะธะต

**ะะตะบะพะผะตะฝะดะฐัะธั**: ะะพะฑะฐะฒะธัั ะปะพะณะธัะพะฒะฐะฝะธะต ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ะฟัะพะฑะปะตะผ:

```typescript
// RealPriceEngine.ts
logger.info(`[RealPriceEngine] ${instrumentId} Time offset: ${this.timeOffsetMs}ms`);
logger.debug(`[RealPriceEngine] ${instrumentId} Market time: ${marketTimeMs}, Server time: ${serverTimeMs}`);

// LineChartController.ts
logger.debug(`[LineChartController] Snapshot for ${symbol}: ${points.length} points`);
if (points.length === 0) {
  logger.warn(`[LineChartController] Empty snapshot for ${symbol} - no history available`);
}
```

---

## ะัะพะณะพะฒะฐั ัะฐะฑะปะธัะฐ ััะฐะฒะฝะตะฝะธั

| ะัะฟะตะบั | OTC | Real |
|--------|-----|------|
| **ะะตะฝะตัะฐัะธั ัะตะฝ** | ะะปะณะพัะธัะผ Controlled Random Walk | WebSocket ะพั xchangeapi.com |
| **ะงะฐััะพัะฐ ะพะฑะฝะพะฒะปะตะฝะธะน** | ะะฐะถะดัะต 500ms | ะะพ ะผะตัะต ะฟะพัััะฟะปะตะฝะธั (ะพะฑััะฝะพ 5-10 ัะฐะท/ัะตะบ) |
| **ะะพัะผะฐะปะธะทะฐัะธั** | 1 ัะพัะบะฐ/ัะตะบ ะฒ ะะ | 1 ัะพัะบะฐ/ัะตะบ ะฒ ะะ (ะฟะพัะปะต ะฝะพัะผะฐะปะธะทะฐัะธะธ) |
| **ะััะพัะธั** | ะก ะผะพะผะตะฝัะฐ ะทะฐะฟััะบะฐ | ะขะพะปัะบะพ ั ะผะพะผะตะฝัะฐ ะฟะพะดะบะปััะตะฝะธั |
| **Snapshot API** | โ ะะฐะฑะพัะฐะตั (ะตัะปะธ ะตััั ะดะฐะฝะฝัะต ะฒ ะะ) | โ๏ธ ะะพะถะตั ะฑััั ะฟััััะผ |
| **History API** | โ ะะฐะฑะพัะฐะตั | โ๏ธ ะะพะถะตั ะฑััั ะฟััััะผ |
| **Live updates** | โ ะะฐะฑะพัะฐะตั | โ ะะฐะฑะพัะฐะตั |
| **Infinite scroll** | โ ะะฐะฑะพัะฐะตั | โ๏ธ ะะต ัะฐะฑะพัะฐะตั, ะตัะปะธ ะฝะตั ะธััะพัะธะธ |
| **ะัะตะผั** | Server-time (ะดะตัะตัะผะธะฝะธัะพะฒะฐะฝะฝะพะต) | Market-time โ Server-time (ะฝะพัะผะฐะปะธะทะฐัะธั) |
| **ะกะธะฝััะพะฝะธะทะฐัะธั ัะฒะตัะตะน** | โ ะัะตะณะดะฐ ัะธะฝััะพะฝะฝะพ | โ ะกะธะฝััะพะฝะฝะพ (ะฟะพัะปะต ะฝะพัะผะฐะปะธะทะฐัะธะธ) |

---

## ะะฐะบะปััะตะฝะธะต

ะกะธััะตะผะฐ ะฟะพะดะดะตัะถะธะฒะฐะตั ะพะฑะฐ ัะธะฟะฐ ะบะพัะธัะพะฒะพะบ ัะตัะตะท ะตะดะธะฝัั ะฐััะธัะตะบัััั, ะฝะพ ะตััั ะฒะฐะถะฝัะต ะพัะปะธัะธั:

1. **OTC** โ ะฟะพะปะฝะพัััั ะบะพะฝััะพะปะธััะตะผัะต, ััะฐะฑะธะปัะฝัะต, ั ะฟะพะปะฝะพะน ะธััะพัะธะตะน
2. **Real** โ ัะตะฐะปัะฝัะต ััะฝะพัะฝัะต ะดะฐะฝะฝัะต, ะฝะพ ั ะพะณัะฐะฝะธัะตะฝะธัะผะธ ะฟะพ ะธััะพัะธะธ

**ะะปะฐะฒะฝะฐั ะฟัะพะฑะปะตะผะฐ**: ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ ะดะปั Real ะธะฝััััะผะตะฝัะพะฒ ะฝะต ะผะพะถะตั ะทะฐะณััะทะธัั ะธััะพัะธั, ะตัะปะธ ะดะฐะฝะฝัั ะฝะตั ะฒ ะะ. ะญัะพ ััะตะฑัะตั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ัะฐะฑะพัั:
- ะะฝัะตะณัะฐัะธั ั API ะดะปั ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั
- ะฃะปัััะตะฝะธะต ะพะฑัะฐะฑะพัะบะธ ะฟััััั snapshot
- ะฃะปัััะตะฝะธะต UX ะฟัะธ ะพััััััะฒะธะธ ะธััะพัะธะธ
